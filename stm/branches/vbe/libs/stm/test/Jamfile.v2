#
# Boost.Synchro
# Build script for tests.
#
# Copyright (c) 2008-2009 Vicente J. Botet Escriba]
# Distributed under the Boost Software License, Version 1.0.
# (See accompanying file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)

# bring in rules for testing
import testing ;

if ! $(BOOST_ROOT)
{
    BOOST_ROOT = [ modules.peek : BOOST_ROOT ] ;
}

project
    : requirements
#       <library>/boost/test//boost_unit_test_framework/<link>static
        <library>../build//boost_STM/<link>static
        <library>/boost/thread//boost_thread/<link>static

        <include>.
        <include>../../..
        #<include>$BOOST_ROOT
        <include>/boost_1_39_0
        <threading>multi
#       <target-os>cygwin
#       <interthreadapi>pthread
#        <variant>debug
#       <define>BOOST_THREAD_HAS_THREAD_ATTR

    ;

#rule stm-run ( sources * )
#{
#    return
#    [ run $(sources)  :  :  : <link>static ]
##    [ run $(sources)  ../../../../libs/thread/build//boost_thread  :  :  :              : $(sources[1]:B)_lib ]
#    ;
#}

    static-lib all_my_tests
    : stm.cpp testatom.cpp pointer_test.cpp  smart.cpp  globalIntArr.cpp testHashMapAndLinkedListsWithLocks.cpp irrevocableInt.cpp testHashMapWithLocks.cpp isolatedComposedIntLockInTx.cpp   testInt.cpp isolatedComposedIntLockInTx2.cpp  testLL_latm.cpp isolatedInt.cpp testLinkedList.cpp isolatedIntLockInTx.cpp testLinkedListWithLocks.cpp litExample.cpp testPerson.cpp lotExample.cpp testRBTree.cpp  transferFun.cpp nestedTxs.cpp txLinearLock.cpp testHT_latm.cpp usingLockTx.cpp testHashMap.cpp
    ;

    test-suite "tests"
        :
            [ run test_default.cpp .//all_my_tests/<link>static  ]

            [ run test_accounts_dir_t2.cpp .//all_my_tests/<link>static  ]
            [ run test_accounts_def_t2.cpp .//all_my_tests/<link>static  ]

            [ run test_hashmap_dir_t2_i1000.cpp .//all_my_tests/<link>static  ]
            [ run test_hashmap_def_t2_i1000.cpp .//all_my_tests/<link>static  ]

            ########### livelock. killed after 3:00 25% CPU
            #[ run test_ht_dir_t2_i1000.cpp .//all_my_tests/<link>static  ]

            ########### fails
            # /bin/sh: line 4:  2944 Aborted                 (core dumped) "bin/test_ht_def_t2_i1000.test/gcc-3.4.4/debug/threading-multi/test_ht_def_t2_i1000.exe" > "bin/test_ht_def_t2_i1000.test/gcc-3.4.4/debug/threading-multi/test_ht_def_t2_i1000.output" 2>&1
            # Rounding max threads to the next multiple of 4 (4).
            # assertion "res==0" failed: file "../../../boost/synchro/pthread/mutex.hpp", line 40
            [ run test_ht_def_t2_i1000.cpp .//all_my_tests/<link>static  ]

            [ run test_isolated_int_dir_t2.cpp .//all_my_tests/<link>static  ]
            [ run test_isolated_int_def_t2.cpp .//all_my_tests/<link>static  ]

            [ run test_linkedlist_dir_t2_i1000.cpp .//all_my_tests/<link>static  ]
            [ run test_linkedlist_def_t2_i1000.cpp .//all_my_tests/<link>static  ]

            [ run test_ll_dir_t2_i1000.cpp .//all_my_tests/<link>static  ]
            ########### fails
            # assertion "res==0" failed: file "../../../boost/synchro/pthread/mutex.hpp", line 40
            [ run test_ll_def_t2_i1000.cpp .//all_my_tests/<link>static  ]

            ########### fails with CHECK
            #/bin/sh: line 4:  3764 Aborted                 (core dumped) "bin/test_tx_linear_lock_dir_t2.test/gcc-3.4.4/debug/threading-multi/test_tx_linear_lock_dir_t2.exe" > "bin/test_tx_linear_lock_dir_t2.test/gcc-3.4.4/debug/threading-multi/test_tx_linear_lock_dir_t2.output" 2>&1
            #assertion "res==0" failed: file "../../../boost/synchro/pthread/mutex.hpp", line 40
            ########### deadlock. without CHECK
            #[ run test_tx_linear_lock_dir_t2.cpp .//all_my_tests/<link>static  ]
            
            ########### deadlock. killed after 0:26. 00% CPU
            # assertion "res==0" failed: file "../../../boost/synchro/pthread/mutex.hpp", line 40
            #   19469 [sig] test_tx_linear_lock_def_t2 3768 _cygtls::handle_exceptions: Error while dumping state (probably corrupted stack)
            #[ run test_tx_linear_lock_def_t2.cpp .//all_my_tests/<link>static  ]

            [ run test_isolated_int_lock_dir_t2.cpp .//all_my_tests/<link>static  ]
            
            ########### deadlock. killed after 0:26. 00% CPU
            #[ run test_isolated_int_lock_def_t2.cpp .//all_my_tests/<link>static  ]

            ########### deadlock. killed after 0:20. 00% CPU
            #[ run test_isolated_composed_int_lock_dir_t2.cpp .//all_my_tests/<link>static  ]
            
            ###########  fails
            # /bin/sh: line 4:  3660 Segmentation fault      (core dumped) "bin/test_isolated_composed_int_lock_def_t2.test/gcc-3.4.4/debug/threading-multi/test_isolated_composed_int_lock_def_t2.exe" > "bin/test_isolated_composed_int_lock_def_t2.test/gcc-3.4.4/debug/threading-multi/test_isolated_composed_int_lock_def_t2.output" 2>&1
            # assertion "res==0" failed: file "../../../boost/synchro/pthread/mutex.hpp", line 40
            #[ run test_isolated_composed_int_lock_def_t2.cpp .//all_my_tests/<link>static  ]
            
            ###########  fails
            # /bin/sh: line 4:  3172 Aborted                 (core dumped) "bin/test_isolated_composed_int_lock2_dir_t2.test/gcc-3.4.4/debug/threading-multi/test_isolated_composed_int_lock2_dir_t2.exe" > "bin/test_isolated_composed_int_lock2_dir_t2.test/gcc-3.4.4/debug/threading-multi/test_isolated_composed_int_lock2_dir_t2.output" 2>&1
            #assertion "res==0" failed: file "../../../boost/synchro/pthread/mutex.hpp", line 40
            #      11 [sig] test_isolated_composed_int_lock_def_t2 3660 _cygtls::handle_except ions: Error while dumping state (probably corrupted stack)
            [ run test_isolated_composed_int_lock2_dir_t2.cpp .//all_my_tests/<link>static  ]
            
            ###########  fails
            # /bin/sh: line 4:  3172 Aborted                 (core dumped) "bin/test_isolated_composed_int_lock2_dir_t2.test/gcc-3.4.4/debug/threading-multi/test_isolated_composed_int_lock2_dir_t2.exe" > "bin/test_isolated_composed_int_lock2_dir_t2.test/gcc-3.4.4/debug/threading-multi/test_isolated_composed_int_lock2_dir_t2.output" 2>&1
            # ====== BEGIN OUTPUT ======
            # assertion "res==0" failed: file "../../../boost/synchro/pthread/mutex.hpp", line 40
            #[ run test_isolated_composed_int_lock2_def_t2.cpp .//all_my_tests/<link>static  ]

            [ run test_irrevocable_int_dir_t2.cpp .//all_my_tests/<link>static  ]
            [ run test_irrevocable_int_def_t2.cpp .//all_my_tests/<link>static  ]

            ########### deadlock. killed after 0:20. 00% CPU
            #[ run test_lot_dir_t2.cpp .//all_my_tests/<link>static  ]
            ########### deadlock. killed after 0:26. 00% CPU
            #[ run test_lot_def_t2.cpp .//all_my_tests/<link>static  ]

            ########### deadlock. killed after 0:40. 00% CPU
            #[ run test_lit_dir_t2.cpp .//all_my_tests/<link>static  ]
            
            ########### fails with CHECK
            # /bin/sh: line 4:  4072 Aborted                 (core dumped) "bin/test_lit_def_t2.test/gcc-3.4.4/debug/threading-multi/test_lit_def_t2.exe" > "bin/test_lit_def_t2.test/gcc-3.4.4/debug/threading-multi/test_lit_def_t2.output" 2>&1
            ########### deadlock sometimes without CHECK. killed after 0:40. 00% CPU
            #[ run test_lit_def_t2.cpp .//all_my_tests/<link>static  ]

            ########### livelock. killed after 3:00. 50% CPU
            #[ run test_nested_tx_dir_t2.cpp .//all_my_tests/<link>static  ]
            ########### livelock. killed after 3:50. 50% CPU
            #[ run test_nested_tx_def_t2.cpp .//all_my_tests/<link>static  ]

            [ run test_rbtree_dir_t2_i1000.cpp .//all_my_tests/<link>static  ]
            [ run test_rbtree_def_t2_i1000.cpp .//all_my_tests/<link>static  ]

            [ run test_smart_dir_t2.cpp .//all_my_tests/<link>static  ]
            [ run test_smart_def_t2.cpp .//all_my_tests/<link>static  ]

            ########### fails
            #/bin/sh: line 4:   408 Aborted                 (core dumped) "bin/test_using_linkedlist_dir_t2_i1000.test/gcc-3.4.4/debug/threading-multi/test_using_linkedlist_dir_t2_i1000.exe" > "bin/test_using_linkedlist_dir_t2_i1000.test/gcc-3.4.4/debug/threading-multi/test_using_linkedlist_dir_t2_i1000.output" 2>&1
            [ run test_using_linkedlist_dir_t2_i1000.cpp .//all_my_tests/<link>static  ]

            ########### fails
            # /bin/sh: line 4:  2376 Aborted                 (core dumped) "bin/test_using_linkedlist_def_t2_i1000.test/gcc-3.4.4/debug/threading-multi/test_using_linkedlist_def_t2_i1000.exe" > "bin/test_using_linkedlist_def_t2_i1000.test/gcc-3.4.4/debug/threading-multi/test_using_linkedlist_def_t2_i1000.output" 2>&1
            [ run test_using_linkedlist_def_t2_i1000.cpp .//all_my_tests/<link>static  ]


            [ run test_hashmap_w_locks_dir_t2.cpp .//all_my_tests/<link>static  ]
            
            ########### fails
            # assertion "res==0" failed: file "../../../boost/synchro/pthread/mutex.hpp", line 40
            [ run test_hashmap_w_locks_def_t2.cpp .//all_my_tests/<link>static  ]

            [ run test_list_hash_w_locks_dir_t2.cpp .//all_my_tests/<link>static  ]
            ########### fails
            # assertion "res==0" failed: file "../../../boost/synchro/pthread/mutex.hpp", line 40            
            [ run test_list_hash_w_locks_def_t2.cpp .//all_my_tests/<link>static  ]

            [ run ../example/bank.cpp ]

            ########### fails
            #[ run ../example/list.cpp ]
            
            [ run ../example/counter.cpp ]
            [ run ../example/numeric.cpp ]
            [ run ../example/counter_ptr.cpp ]

            ########### fails
            #[ run ../example/non_tx_counter.cpp ]
    ;
