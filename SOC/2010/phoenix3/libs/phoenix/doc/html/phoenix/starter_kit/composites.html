<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>Composites</title>
<link rel="stylesheet" href="../../../../../../doc/html/boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.76.1">
<link rel="home" href="../../index.html" title="Chapter&#160;1.&#160;Phoenix 3.0">
<link rel="up" href="../starter_kit.html" title="Starter Kit">
<link rel="prev" href="primitives.html" title="Primitives">
<link rel="next" href="../reference.html" title="Reference">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr><td valign="top"></td></tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="primitives.html"><img src="../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../starter_kit.html"><img src="../../images/up.png" alt="Up"></a><a accesskey="h" href="../../index.html"><img src="../../images/home.png" alt="Home"></a><a accesskey="n" href="../reference.html"><img src="../../images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="phoenix.starter_kit.composites"></a><a class="link" href="composites.html" title="Composites">Composites</a>
</h3></div></div></div>
<div class="toc"><dl>
<dt><span class="section"><a href="composites.html#phoenix.starter_kit.composites.lazy_operators">Lazy
        Operators</a></span></dt>
<dt><span class="section"><a href="composites.html#phoenix.starter_kit.composites.lazy_statements">Lazy
        Statements</a></span></dt>
<dt><span class="section"><a href="composites.html#phoenix.starter_kit.composites.construct__new__delete__casts">Construct,
        New, Delete, Casts</a></span></dt>
<dt><span class="section"><a href="composites.html#phoenix.starter_kit.composites.lazy_functions">Lazy
        Functions</a></span></dt>
<dt><span class="section"><a href="composites.html#phoenix.starter_kit.composites.more">More</a></span></dt>
</dl></div>
<p>
        Things start to get interesting when we start <span class="emphasis"><em>composing</em></span>
        primitives to form <span class="bold"><strong>composites</strong></span>. The composites
        can, in turn, be composed to form even more complex composites.
      </p>
<div class="section">
<div class="titlepage"><div><div><h4 class="title">
<a name="phoenix.starter_kit.composites.lazy_operators"></a><a class="link" href="composites.html#phoenix.starter_kit.composites.lazy_operators" title="Lazy Operators">Lazy
        Operators</a>
</h4></div></div></div>
<p>
          You can use the usual set of operators to form composites. Examples:
        </p>
<pre class="programlisting"><span class="identifier">arg1</span> <span class="special">*</span> <span class="identifier">arg1</span>
<span class="identifier">ref</span><span class="special">(</span><span class="identifier">x</span><span class="special">)</span> <span class="special">=</span> <span class="identifier">arg1</span> <span class="special">+</span> <span class="identifier">ref</span><span class="special">(</span><span class="identifier">z</span><span class="special">)</span>
<span class="identifier">arg1</span> <span class="special">=</span> <span class="identifier">arg2</span> <span class="special">+</span> <span class="special">(</span><span class="number">3</span> <span class="special">*</span> <span class="identifier">arg3</span><span class="special">)</span>
<span class="identifier">ref</span><span class="special">(</span><span class="identifier">x</span><span class="special">)</span> <span class="special">=</span> <span class="identifier">arg1</span><span class="special">[</span><span class="identifier">arg2</span><span class="special">]</span> <span class="comment">// assuming arg1 is indexable and arg2 is a valid index
</span></pre>
<p>
          Note the expression: <code class="computeroutput"><span class="number">3</span> <span class="special">*</span>
          <span class="identifier">arg3</span></code>. This expression is actually
          a short-hand equivalent to: <code class="computeroutput"><span class="identifier">val</span><span class="special">(</span><span class="number">3</span><span class="special">)</span>
          <span class="special">*</span> <span class="identifier">arg3</span></code>.
          In most cases, like above, you can get away with it. But in some cases,
          you will have to explicitly wrap your values in <code class="computeroutput"><span class="identifier">val</span></code>.
          Rules of thumb:
        </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">
              In a binary expression (e.g. <code class="computeroutput"><span class="number">3</span>
              <span class="special">*</span> <span class="identifier">arg3</span></code>),
              at least one of the operands must be a phoenix primitive or composite.
            </li>
<li class="listitem">
              In a unary expression (e.g. <code class="computeroutput"><span class="identifier">arg1</span><span class="special">++</span></code>), the single operand must be a phoenix
              primitive or composite.
            </li>
</ul></div>
<p>
          If these basic rules are not followed, the result is either an error, or
          is immediately evaluated. Some examples:
        </p>
<pre class="programlisting"><span class="identifier">ref</span><span class="special">(</span><span class="identifier">x</span><span class="special">)</span> <span class="special">=</span> <span class="number">123</span>    <span class="comment">// lazy
</span><span class="identifier">x</span> <span class="special">=</span> <span class="number">123</span>         <span class="comment">// immediate
</span>
<span class="identifier">ref</span><span class="special">(</span><span class="identifier">x</span><span class="special">)[</span><span class="number">0</span><span class="special">]</span>       <span class="comment">// lazy
</span><span class="identifier">x</span><span class="special">[</span><span class="number">0</span><span class="special">]</span>            <span class="comment">// immediate
</span>
<span class="identifier">ref</span><span class="special">(</span><span class="identifier">x</span><span class="special">)[</span><span class="identifier">ref</span><span class="special">(</span><span class="identifier">i</span><span class="special">)]</span>  <span class="comment">// lazy
</span><span class="identifier">ref</span><span class="special">(</span><span class="identifier">x</span><span class="special">)[</span><span class="identifier">i</span><span class="special">]</span>       <span class="comment">// lazy (equivalent to ref(x)[val(i)])
</span><span class="identifier">x</span><span class="special">[</span><span class="identifier">ref</span><span class="special">(</span><span class="identifier">i</span><span class="special">)]</span>       <span class="comment">// illegal (x is not a phoenix primitive or composite)
</span><span class="identifier">ref</span><span class="special">(</span><span class="identifier">x</span><span class="special">[</span><span class="identifier">ref</span><span class="special">(</span><span class="identifier">i</span><span class="special">)])</span>  <span class="comment">// illegal (x is not a phoenix primitive or composite)
</span></pre>
<div class="sidebar">
<div class="titlepage"></div>
<p>
          <span class="inlinemediaobject"><img src="../../images/tip.png" alt="tip"></span> Learn more about operators <a class="link" href="../../">here.</a>
        </p>
</div>
<a name="phoenix.starter_kit.composites.lazy_operators.first_practical_example"></a><h6>
<a name="id608513"></a>
          <a class="link" href="composites.html#phoenix.starter_kit.composites.lazy_operators.first_practical_example">First
          Practical Example</a>
        </h6>
<p>
          We've covered enough ground to present a real world example. We want to
          find the first odd number in an STL container. Normally we use a functor
          (function object) or a function pointer and pass that in to STL's <code class="computeroutput"><span class="identifier">find_if</span></code> generic function:
        </p>
<p>
          Write a function:
        </p>
<pre class="programlisting"><span class="keyword">bool</span>
<span class="identifier">is_odd</span><span class="special">(</span><span class="keyword">int</span> <span class="identifier">arg1</span><span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">arg1</span> <span class="special">%</span> <span class="number">2</span> <span class="special">==</span> <span class="number">1</span><span class="special">;</span>
<span class="special">}</span>
</pre>
<p>
          Pass a pointer to the function to STL's <code class="computeroutput"><span class="identifier">find_if</span></code>
          algorithm:
        </p>
<pre class="programlisting"><span class="identifier">std</span><span class="special">::</span><span class="identifier">find_if</span><span class="special">(</span><span class="identifier">c</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">c</span><span class="special">.</span><span class="identifier">end</span><span class="special">(),</span> <span class="special">&amp;</span><span class="identifier">is_odd</span><span class="special">)</span>
</pre>
<p>
          Using Phoenix, the same can be achieved directly with a one-liner:
        </p>
<pre class="programlisting"><span class="identifier">std</span><span class="special">::</span><span class="identifier">find_if</span><span class="special">(</span><span class="identifier">c</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">c</span><span class="special">.</span><span class="identifier">end</span><span class="special">(),</span> <span class="identifier">arg1</span> <span class="special">%</span> <span class="number">2</span> <span class="special">==</span> <span class="number">1</span><span class="special">)</span>
</pre>
<p>
          The expression <code class="computeroutput"><span class="identifier">arg1</span> <span class="special">%</span>
          <span class="number">2</span> <span class="special">==</span> <span class="number">1</span></code> automagically creates a functor with the
          expected behavior. In FP, this unnamed function is called a lambda function.
          Unlike the function pointer version, which is monomorphic (expects and
          works only with a fixed type int argument), the Phoenix version is fully
          polymorphic and works with any container (of ints, of longs, of bignum,
          etc.) as long as its elements can handle the <code class="computeroutput"><span class="identifier">arg1</span>
          <span class="special">%</span> <span class="number">2</span> <span class="special">==</span> <span class="number">1</span></code> expression.
        </p>
<p>
          (See <a href="../../../../example/find_if.cpp" target="_top">find_if.cpp</a>)
        </p>
<div class="sidebar">
<div class="titlepage"></div>
<p>
          <span class="inlinemediaobject"><img src="../../images/tip.png" alt="tip"></span> ...<span class="bold"><strong>That's it, we're done</strong></span>.
          Well if you wish to know a little bit more, read on...
        </p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div><h4 class="title">
<a name="phoenix.starter_kit.composites.lazy_statements"></a><a class="link" href="composites.html#phoenix.starter_kit.composites.lazy_statements" title="Lazy Statements">Lazy
        Statements</a>
</h4></div></div></div>
<p>
          Lazy statements? Sure. There are lazy versions of the C++ statements we
          all know and love. For example:
        </p>
<pre class="programlisting"><span class="identifier">if_</span><span class="special">(</span><span class="identifier">arg1</span> <span class="special">&gt;</span> <span class="number">5</span><span class="special">)</span>
<span class="special">[</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">arg1</span>
<span class="special">]</span>
</pre>
<p>
          Say, for example, we wish to print all the elements that are greater than
          5 (separated by a comma) in a vector. Here's how we write it:
        </p>
<pre class="programlisting"><span class="identifier">std</span><span class="special">::</span><span class="identifier">for_each</span><span class="special">(</span><span class="identifier">v</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">v</span><span class="special">.</span><span class="identifier">end</span><span class="special">(),</span>
    <span class="identifier">if_</span><span class="special">(</span><span class="identifier">arg1</span> <span class="special">&gt;</span> <span class="number">5</span><span class="special">)</span>
    <span class="special">[</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">arg1</span> <span class="special">&lt;&lt;</span> <span class="string">", "</span>
    <span class="special">]</span>
<span class="special">);</span>
</pre>
<p>
          (See <a href="../../../../example/if.cpp" target="_top">if.cpp</a>)
        </p>
<div class="sidebar">
<div class="titlepage"></div>
<p>
          <span class="inlinemediaobject"><img src="../../images/tip.png" alt="tip"></span> Learn more about statements <a class="link" href="../../">here.</a>
        </p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div><h4 class="title">
<a name="phoenix.starter_kit.composites.construct__new__delete__casts"></a><a class="link" href="composites.html#phoenix.starter_kit.composites.construct__new__delete__casts" title="Construct, New, Delete, Casts">Construct,
        New, Delete, Casts</a>
</h4></div></div></div>
<p>
          You'll probably want to work with objects. There are lazy versions of constructor
          calls, <code class="computeroutput"><span class="keyword">new</span></code>, <code class="computeroutput"><span class="keyword">delete</span></code> and the suite of C++ casts. Examples:
        </p>
<pre class="programlisting"><span class="identifier">construct</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">&gt;(</span><span class="identifier">arg1</span><span class="special">,</span> <span class="identifier">arg2</span><span class="special">)</span>  <span class="comment">// constructs a std::string from arg1, arg2
</span><span class="identifier">new_</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">&gt;(</span><span class="identifier">arg1</span><span class="special">,</span> <span class="identifier">arg2</span><span class="special">)</span>       <span class="comment">// makes a new std::string from arg1, arg2
</span><span class="identifier">delete_</span><span class="special">(</span><span class="identifier">arg1</span><span class="special">)</span>                       <span class="comment">// deletes arg1 (assumed to be a pointer)
</span><span class="identifier">static_cast_</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">*&gt;(</span><span class="identifier">arg1</span><span class="special">)</span>            <span class="comment">// static_cast's arg1 to an int*
</span></pre>
<div class="note"><table border="0" summary="Note">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="../../images/note.png"></td>
<th align="left">Note</th>
</tr>
<tr><td align="left" valign="top"><p>
            Take note that, by convention, names that conflict with C++ reserved
            words are appended with a single trailing underscore <code class="computeroutput"><span class="char">'_'</span></code>
          </p></td></tr>
</table></div>
<div class="sidebar">
<div class="titlepage"></div>
<p>
          <span class="inlinemediaobject"><img src="../../images/tip.png" alt="tip"></span> Learn more about this <a class="link" href="../../">here.</a>
        </p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div><h4 class="title">
<a name="phoenix.starter_kit.composites.lazy_functions"></a><a class="link" href="composites.html#phoenix.starter_kit.composites.lazy_functions" title="Lazy Functions">Lazy
        Functions</a>
</h4></div></div></div>
<p>
          As you write more lambda functions, you'll notice certain patterns that
          you wish to refactor as reusable functions. When you reach that point,
          you'll wish that ordinary functions can co-exist with phoenix functions.
          Unfortunately, the <span class="emphasis"><em>immediate</em></span> nature of plain C++ functions
          make them incompatible.
        </p>
<p>
          Lazy functions are your friends. The library provides a facility to make
          lazy functions. The code below is a rewrite of the <code class="computeroutput"><span class="identifier">is_odd</span></code>
          function using the facility:
        </p>
<pre class="programlisting"><span class="keyword">struct</span> <span class="identifier">is_odd_impl</span>
<span class="special">{</span>
    <span class="keyword">typedef</span> <span class="keyword">bool</span> <span class="identifier">result_type</span><span class="special">;</span>

    <span class="keyword">template</span> <span class="special">&lt;</span><span class="keyword">typename</span> <span class="identifier">Arg</span><span class="special">&gt;</span>
    <span class="keyword">bool</span> <span class="keyword">operator</span><span class="special">()(</span><span class="identifier">Arg</span> <span class="identifier">arg1</span><span class="special">)</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">arg1</span> <span class="special">%</span> <span class="number">2</span> <span class="special">==</span> <span class="number">1</span><span class="special">;</span>
    <span class="special">}</span>
<span class="special">};</span>

<span class="identifier">function</span><span class="special">&lt;</span><span class="identifier">is_odd_impl</span><span class="special">&gt;</span> <span class="identifier">is_odd</span><span class="special">;</span>
</pre>
<a name="phoenix.starter_kit.composites.lazy_functions.things_to_note_"></a><h6>
<a name="id609592"></a>
          <a class="link" href="composites.html#phoenix.starter_kit.composites.lazy_functions.things_to_note_">Things
          to note:</a>
        </h6>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">
              Result type deduction is implemented with the help of the result_of
              protocol. For more information see <a href="http://www.boost.org/doc/libs/1_43_0/libs/utility/utility.htm#result_of" target="_top">Boost.Result
              Of</a>
            </li>
<li class="listitem">
              <code class="computeroutput"><span class="identifier">is_odd_impl</span></code> implements
              the function.
            </li>
<li class="listitem">
              <code class="computeroutput"><span class="identifier">is_odd</span></code>, an instance
              of <code class="computeroutput"><span class="identifier">function</span><span class="special">&lt;</span><span class="identifier">is_odd_impl</span><span class="special">&gt;</span></code>,
              is the lazy function.
            </li>
</ul></div>
<p>
          Now, <code class="computeroutput"><span class="identifier">is_odd</span></code> is a truly
          lazy function that we can use in conjunction with the rest of phoenix.
          Example:
        </p>
<pre class="programlisting"><span class="identifier">std</span><span class="special">::</span><span class="identifier">find_if</span><span class="special">(</span><span class="identifier">c</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">c</span><span class="special">.</span><span class="identifier">end</span><span class="special">(),</span> <span class="identifier">is_odd</span><span class="special">(</span><span class="identifier">arg1</span><span class="special">));</span>
</pre>
<p>
          (See <a href="../../../../example/function.cpp" target="_top">function.cpp</a>)
        </p>
<a name="phoenix.starter_kit.composites.lazy_functions.predefined_lazy_functions"></a><h6>
<a name="id609770"></a>
          <a class="link" href="composites.html#phoenix.starter_kit.composites.lazy_functions.predefined_lazy_functions">Predefined
          Lazy Functions</a>
        </h6>
<p>
          The library is chock full of STL savvy, predefined lazy functions covering
          the whole of the STL containers, iterators and algorithms. For example,
          there are lazy versions of container related operations such as assign,
          at, back, begin, pop_back, pop_front, push_back, push_front, etc. (See
          <a class="link" href="../../">STL</a>).
        </p>
</div>
<div class="section">
<div class="titlepage"><div><div><h4 class="title">
<a name="phoenix.starter_kit.composites.more"></a><a class="link" href="composites.html#phoenix.starter_kit.composites.more" title="More">More</a>
</h4></div></div></div>
<p>
          As mentioned earlier, this chapter is not a thorough discourse of the library.
          It is meant only to cover enough ground to get you into high gear as quickly
          as possible. Some advanced stuff is not discussed here (e.g. <a class="link" href="../../">Scopes</a>);
          nor are features that provide alternative (short-hand) ways to do the same
          things (e.g. <a class="link" href="../../">Bind</a>
          vs. <a class="link" href="../../">Lazy Functions</a>).
        </p>
<div class="sidebar">
<div class="titlepage"></div>
<p>
          <span class="inlinemediaobject"><img src="../../images/tip.png" alt="tip"></span> ...<span class="bold"><strong>If you still wish to learn
          more, the read on...</strong></span>
        </p>
</div>
</div>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2002-2005, 2010 Joel de Guzman, Dan Marsden, Thomas Heller<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="primitives.html"><img src="../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../starter_kit.html"><img src="../../images/up.png" alt="Up"></a><a accesskey="h" href="../../index.html"><img src="../../images/home.png" alt="Home"></a><a accesskey="n" href="../reference.html"><img src="../../images/next.png" alt="Next"></a>
</div>
</body>
</html>
