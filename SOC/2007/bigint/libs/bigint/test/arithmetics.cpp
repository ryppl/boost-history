/* Boost arithmetics.cpp test file
 *
 * Copyright 2007 Arseny Kapoulkine
 *
 * Distributed under the Boost Software License, Version 1.0.
 * (See accompanying file LICENSE_1_0.txt or
 * copy at http://www.boost.org/LICENSE_1_0.txt)
 */

#define BOOST_DISABLE_WIN32

#include <boost/test/included/test_exec_monitor.hpp>

#include <boost/bigint/bigint.hpp>

#ifdef BOOST_BIGINT_HAS_GMP_SUPPORT
#	include <boost/bigint/bigint_gmp.hpp>
#endif

#include <boost/bigint/bigint_default.hpp>
#include <boost/bigint/bigint_storage_vector.hpp>
#include <boost/bigint/bigint_storage_fixed.hpp>

#pragma comment(lib, "libgmp-3.lib")

// This macro is not quite good, but - it's ok for our needs
#define ARRAY_SIZE(array) sizeof(array) / sizeof(array[0])

template <typename I> void test()
{
	typedef boost::bigint_base<I> number;

	struct test_entry
	{
		const char* lhs;
		char op;
		const char* rhs;
		const char* result;
	};

	test_entry entries[] =
	{
		// addition

		// same sign, no carries
		{"3", '+', "1", "4"},
		{"1", '+', "3", "4"},
		// same sign, carries
		{"18446744073709551615", '+', "1", "18446744073709551616"},
		{"1", '+', "18446744073709551615", "18446744073709551616"},
		{"18446744073709551615", '+', "18446744073709551615", "36893488147419103230"},
		// different sign, positive result
		{"138493849343434", '+', "-128932839", "138493720410595"},
		{"-128932839", '+', "138493849343434", "138493720410595"},
		// different sign, negative result
		{"-2903920392323129", '+', "5293092323", "-2903915099230806"},
		{"5293092323", '+', "-2903920392323129", "-2903915099230806"},
		// negative numbers
		{"-18446744073709551615", '+', "-4", "-18446744073709551619"},
		{"-4", '+', "-18446744073709551615", "-18446744073709551619"},
		// result is zero
		{"-18446744073709551615", '+', "18446744073709551615", "0"},
		{"18446744073709551615", '+', "-18446744073709551615", "0"},

		// from Big Integer Library by Richard Peters
		{"144331033935567457577760483977112339622", '+', "144331033935567457577760483977112339622", "288662067871134915155520967954224679244"},
		{"144331033935567457577760483977112339622", '+', "-201953533416687960474015014674164876681177661631133973318", "-201953533416687960329683980738597419103417177654021633696"},
		{"144331033935567457577760483977112339622", '+', "33258231137356853400843467155353708599218251522729505441041591237", "33258231137356853400843467299684742534785709100489989418153930859"},
		{"144331033935567457577760483977112339622", '+', "202681457102058583257910713873340545496276314517960701795263144802871633", "202681457102058583257910713873340689827310250085418279555747121915211255"},
		{"-201953533416687960474015014674164876681177661631133973318", '+', "-201953533416687960474015014674164876681177661631133973318", "-403907066833375920948030029348329753362355323262267946636"},
		{"-201953533416687960474015014674164876681177661631133973318", '+', "33258231137356853400843467155353708599218251522729505441041591237", "33258230935403319984155506681338693925053374841551843809907617919"},
		{"-201953533416687960474015014674164876681177661631133973318", '+', "202681457102058583257910713873340545496276314517960701795263144802871633", "202681457102058381304377297185380071481261640353084020617601513668898315"},
		{"33258231137356853400843467155353708599218251522729505441041591237", '+', "33258231137356853400843467155353708599218251522729505441041591237", "66516462274713706801686934310707417198436503045459010882083182474"},
		{"33258231137356853400843467155353708599218251522729505441041591237", '+', "202681457102058583257910713873340545496276314517960701795263144802871633", "202681490360289720614764114716807700849984913736212224524768585844462870"},
		{"202681457102058583257910713873340545496276314517960701795263144802871633", '+', "202681457102058583257910713873340545496276314517960701795263144802871633", "405362914204117166515821427746681090992552629035921403590526289605743266"},

		// subtraction

		// same sign, no borrows
		{"3", '-', "1", "2"},
		{"-39043434", '-', "-599509", "-38443925"},
		// same sign, borrows
		{"3", '-', "4", "-1"},
		{"-39043434304928394", '-', "-523243892384923499509", "523204848950618571115"},
		// different sign, positive result
		{"2390492304934", '-', "-2342930493043943434", "2342932883536248368"},
		{"123940", '-', "-1003", "124943"},
		// different sign, negative result
		{"-239402390434", '-', "2349034", "-239404739468"},
		{"239049304", '-', "39049230492304", "-39048991443000"},
		// result is zero
		{"-18446744073709551615", '-', "-18446744073709551615", "0"},
		{"18446744073709551615", '-', "18446744073709551615", "0"},

		// from Big Integer Library by Richard Peters
		{"144331033935567457577760483977112339622", '-', "144331033935567457577760483977112339622", "0"},
		{"144331033935567457577760483977112339622", '-', "-201953533416687960474015014674164876681177661631133973318", "201953533416687960618346048609732334258938145608246312940"},
		{"144331033935567457577760483977112339622", '-', "33258231137356853400843467155353708599218251522729505441041591237", "-33258231137356853400843467011022674663650793944969021463929251615"},
		{"144331033935567457577760483977112339622", '-', "202681457102058583257910713873340545496276314517960701795263144802871633", "-202681457102058583257910713873340401165242378950503124034779167690532011"},
		{"-201953533416687960474015014674164876681177661631133973318", '-', "-201953533416687960474015014674164876681177661631133973318", "0"},
		{"-201953533416687960474015014674164876681177661631133973318", '-', "33258231137356853400843467155353708599218251522729505441041591237", "-33258231339310386817531427629368723273383128203907167072175564555"},
		{"-201953533416687960474015014674164876681177661631133973318", '-', "202681457102058583257910713873340545496276314517960701795263144802871633", "-202681457102058785211444130561301019511290988682837382972924775936844951"},
		{"33258231137356853400843467155353708599218251522729505441041591237", '-', "33258231137356853400843467155353708599218251522729505441041591237", "0"},
		{"33258231137356853400843467155353708599218251522729505441041591237", '-', "202681457102058583257910713873340545496276314517960701795263144802871633", "-202681423843827445901057313029873390142567715299709179065757703761280396"},
		{"202681457102058583257910713873340545496276314517960701795263144802871633", '-', "202681457102058583257910713873340545496276314517960701795263144802871633", "0"},

		// multiplication

		// zero
		{"234902394023940234", '*', "0", "0"},
		{"0", '*', "234902394023940234", "0"},
		// positive * positive
		{"2389428394283434234234", '*', "895489472863784783", "2139707973242632227811083664960586861222"},
		{"895489472863784783", '*', "2389428394283434234234", "2139707973242632227811083664960586861222"},
		// different magnitudes
		{"2384", '*', "2389428349283942034234", "5696397184692917809613856"},
		{"2389428349283942034234", '*', "2384", "5696397184692917809613856"},
		// 10^n
		{"1000000000000000", '*', "100000000", "100000000000000000000000"},
		{"10000", '*', "10000000000000000000", "100000000000000000000000"},
		// different signs
		{"123940932409302930429304", '*', "-23940239409234", "-2967175594482401511466585794961793136"},
		{"-4895849540949", '*', "5906390354334334989", "-28916798504933355408364838964561"},
		// negative * negative
		{"-23489238492334893", '*', "-2930482394829348293489234", "68834799869735267747353413198446618041962"},
		{"-39403940", '*', "-90689586573473848347384834", "3573527027965969111849451155845960"},

		// from Big Integer Library by Richard Peters
		{"144331033935567457577760483977112339622", '*', "144331033935567457577760483977112339622", "20831447356909925062050164636507807502299831464416847033282039093578671102884"},
		{"144331033935567457577760483977112339622", '*', "-201953533416687960474015014674164876681177661631133973318", "-29148162284971746581373804476336682757699657139555873885010408383164260114557170019679902205796"},
		{"144331033935567457577760483977112339622", '*', "33258231137356853400843467155353708599218251522729505441041591237", "4800194886922798289683761441724659466646965587105046561478640138067153373379183258124815665194843092414"},
		{"144331033935567457577760483977112339622", '*', "202681457102058583257910713873340545496276314517960701795263144802871633", "29253224263107477267259633707204673908171590310734050748188031160733891198210577108075962524562010304765742726"},
		{"-201953533416687960474015014674164876681177661631133973318", '*', "-201953533416687960474015014674164876681177661631133973318", "40785229659485300726212230220983180513132175206583821232262327224829652995464585331893205979113390672165935929124"},
		{"-201953533416687960474015014674164876681177661631133973318", '*', "33258231137356853400843467155353708599218251522729505441041591237", "-6716617293378129327662011328220644005702996700056417620898494874171306532918252666663893949355252692095436122901020614366"},
		{"-201953533416687960474015014674164876681177661631133973318", '*', "202681457102058583257910713873340545496276314517960701795263144802871633", "-40932236419803595447668075585915625205735648128249743480498808995089542692372861318551693654245696360311077380994768591601088294"},
		{"33258231137356853400843467155353708599218251522729505441041591237", '*', "33258231137356853400843467155353708599218251522729505441041591237", "1106109938385852938543680427168136603410954248378521220168491554819810960946208227772891785974501289220063511976380570864995190169"},
		{"33258231137356853400843467155353708599218251522729505441041591237", '*', "202681457102058583257910713873340545496276314517960701795263144802871633", "6740826747556542127761131910207818991713914643291451903775309886139361506308151690778975214694000820227431267338394269630916705368680021"},
		{"202681457102058583257910713873340545496276314517960701795263144802871633", '*', "202681457102058583257910713873340545496276314517960701795263144802871633", "41079773053013613718554254944129443500101234432431175613774528976328697103926347327658851266012357988396264836364789165142640820591163076086689"},

		// division

		// zero
		{"0", '/', "23904293402394023940", "0"},
		// positive / larger positive
		{"239409034", '/', "23489023049230492304230493049034", "0"},
		{"-239409034", '/', "23489023049230492304230493049034", "0"},
		{"239409034", '/', "-23489023049230492304230493049034", "0"},
		// ~ equal magnitudes
		{"39049204923049203490234", '/', "39049204923049203490230", "1"},
		{"-39049204923049203490234", '/', "39049204923049203490230", "-1"},
		{"39049204923049203490234", '/', "-39049204923049203490230", "-1"},
		// some other numbers
		{"13940239402394034213904", '/', "49850", "279643719205497175"},
		{"-9049594859482398349", '/', "-3401", "2660862940159482"},
		// proper rounding for positive numbers
		{"3", '/', "2", "1"},
		{"9304", '/', "3", "3101"},
		{"394093", '/', "11", "35826"},
		// proper rounding for positive results (negative numbers)
		{"-3", '/', "-2", "1"},
		{"-9304", '/', "-3", "3101"},
		{"-394093", '/', "-11", "35826"},
		// proper rounding for positive / negative (towards zero)
		{"-3", '/', "2", "-1"},
		{"-9304", '/', "3", "-3101"},
		{"-394093", '/', "11", "-35826"},
		// proper rounding for negative / positive (towards zero)
		{"3", '/', "-2", "-1"},
		{"9304", '/', "-3", "-3101"},
		{"394093", '/', "-11", "-35826"},

		// from Big Integer Library by Richard Peters
		{"144331033935567457577760483977112339622", '/', "144331033935567457577760483977112339622", "1"},
		{"144331033935567457577760483977112339622", '/', "-201953533416687960474015014674164876681177661631133973318", "0"},
		{"33258231137356853400843467155353708599218251522729505441041591237", '/', "144331033935567457577760483977112339622", "230430214697998061766383430"},
		{"202681457102058583257910713873340545496276314517960701795263144802871633", '/', "144331033935567457577760483977112339622", "1404281889870892463084548210312903"},
		{"-201953533416687960474015014674164876681177661631133973318", '/', "-201953533416687960474015014674164876681177661631133973318", "1"},
		{"33258231137356853400843467155353708599218251522729505441041591237", '/', "-201953533416687960474015014674164876681177661631133973318", "-164682590"},
		{"-201953533416687960474015014674164876681177661631133973318", '/', "202681457102058583257910713873340545496276314517960701795263144802871633", "0"},
		{"33258231137356853400843467155353708599218251522729505441041591237", '/', "33258231137356853400843467155353708599218251522729505441041591237", "1"},
		{"202681457102058583257910713873340545496276314517960701795263144802871633", '/', "33258231137356853400843467155353708599218251522729505441041591237", "6094174"},
		{"202681457102058583257910713873340545496276314517960701795263144802871633", '/', "202681457102058583257910713873340545496276314517960701795263144802871633", "1"},

		// modulo

		// zero
		{"0", '%', "134", "0"},
		// sign of the left hand value has to be equal to the sign of the remainder
		{"34", '%', "5", "4"},
		{"34", '%', "-5", "4"},
		{"-34", '%', "5", "-4"},
		{"-34", '%', "-5", "-4"},
		// some other numbers
		{"2394023940394034", '%', "100", "34"},
		{"2394023940394034", '%', "9", "5"},
		{"2394023940394034", '%', "8", "2"},
		{"2394023940394034", '%', "234890234034", "22675119506"},
		
		// from Big Integer Library by Richard Peters
		{"144331033935567457577760483977112339622", '%', "144331033935567457577760483977112339622", "0"},
		{"144331033935567457577760483977112339622", '%', "-201953533416687960474015014674164876681177661631133973318", "144331033935567457577760483977112339622"},
		{"33258231137356853400843467155353708599218251522729505441041591237", '%', "144331033935567457577760483977112339622", "24800979404810559550560636164208327777"},
		{"202681457102058583257910713873340545496276314517960701795263144802871633", '%', "144331033935567457577760483977112339622", "57147793758571412114807420585778128967"},
		{"-201953533416687960474015014674164876681177661631133973318", '%', "-201953533416687960474015014674164876681177661631133973318", "0"},
		{"33258231137356853400843467155353708599218251522729505441041591237", '%', "-201953533416687960474015014674164876681177661631133973318", "194645130848165046839924230620331309955170738078042457617"},
		{"-201953533416687960474015014674164876681177661631133973318", '%', "202681457102058583257910713873340545496276314517960701795263144802871633", "-201953533416687960474015014674164876681177661631133973318"},
		{"33258231137356853400843467155353708599218251522729505441041591237", '%', "33258231137356853400843467155353708599218251522729505441041591237", "0"},
		{"202681457102058583257910713873340545496276314517960701795263144802871633", '%', "33258231137356853400843467155353708599218251522729505441041591237", "9618788018540678878265330013747344025762682140703608946567718395"},
		{"202681457102058583257910713873340545496276314517960701795263144802871633", '%', "202681457102058583257910713873340545496276314517960701795263144802871633", "0"},

		// bit-and

		// zero
		{"0", '&', "3894823948293489234", "0"},
		// positive vs positive
		{"4", '&', "6", "4"},
		{"2855076450534541305", '&', "13904", "1616"},
		{"9095384758374758347534", '&', "239892384938492384080", "239879959323226100480"},
		// -1
		{"23904823948293482934", '&', "-1", "23904823948293482934"},
		// positive vs negative
		{"13", '&', "-3", "13"}, // 1101 & 1...101
		{"15", '&', "-3", "13"}, // 1111 & 1...101
		// negative vs negative
		{"-4", '&', "-6", "-8"}, // 1...1100 & 1...1010
		{"-2855076450534541305", '&', "-13904", "-2855076450534553600"},
		{"-9095384758374758347534", '&', "-239892384938492384080", "-9095397183990024631120"},

		// bit-or

		// zero
		{"0", '|', "3894823948293489234", "3894823948293489234"},
		// positive vs positive
		{"4", '|', "6", "6"},
		{"2855076450534541305", '|', "13904", "2855076450534553593"},
		{"9095384758374758347534", '|', "239892384938492384080", "9095397183990024631134"},
		// -1
		{"23904823948293482934", '|', "-1", "-1"},
		// positive vs negative
		{"13", '|', "-3", "-3"}, // 1101 | 1...101
		{"15", '|', "-3", "-1"}, // 1111 | 1...101
		// negative vs negative
		{"-4", '|', "-6", "-2"},
		{"-2855076450534541305", '|', "-13904", "-1609"},
		{"-9095384758374758347534", '|', "-239892384938492384080", "-239879959323226100494"},

		// bit-xor
		
		// zero
		{"0", '^', "3894823948293489234", "3894823948293489234"},
		// positive vs positive
		{"4", '^', "6", "2"},
		{"2855076450534541305", '^', "13904", "2855076450534551977"},
		{"9095384758374758347534", '^', "239892384938492384080", "8855517224666798530654"},
		// -1
		{"23904823948293482934", '^', "-1", "-23904823948293482935"},
		// positive vs negative
		{"13", '^', "-3", "-16"}, // 1101 ^ 1...1101
		{"15", '^', "-3", "-14"}, // 1111 ^ 1...1101
		// negative vs negative
		{"-4", '^', "-6", "6"},
		{"-2855076450534541305", '^', "-13904", "2855076450534551991"},
		{"-9095384758374758347534", '^', "-239892384938492384080", "8855517224666798530626"},

		// left shift

		// zero
		{"0", '<', "2389042304", "0"},
		{"1238923498294", '<', "0", "1238923498294"},
		{"-1238923498294", '<', "0", "-1238923498294"},
		// positive numbers - a << n is equal to a * 2^n
		{"1", '<', "10", "1024"},
		{"13498", '<', "15", "442302464"},
		{"94172371", '<', "65", "3474347253302854482051203072"},
		// negative numbers - a << n is equal to a * 2^n
		{"-1", '<', "10", "-1024"},
		{"-13498", '<', "15", "-442302464"},
		{"-94172371", '<', "65", "-3474347253302854482051203072"},

		// right shift
		
		// zero
		{"0", '>', "2389042304", "0"},
		{"1238923498294", '>', "0", "1238923498294"},
		{"-1238923498294", '>', "0", "-1238923498294"},
		// positive numbers - a >> n is equal to floor(a / 2^n)
		{"1", '>', "10", "0"},
		{"11248972814738247", '>', "15", "343291406699"},
		{"3474347253302854482051234871283", '>', "65", "94172371000"},
		// negative numbers - a >> n is equal to floor(a / 2^n) (rounding to -infinity!)
		{"-1024", '>', "10", "-1"},
		{"-1024", '>', "100", "-1"}, // sign bit!
		{"-442302464", '>', "15", "-13498"},
		{"-3474347253302854482051203072", '>', "65", "-94172371"},
		{"-33", '>', "4", "-3"},
		{"-23894283948234823948324123", '>', "71", "-10120"}
	};

	for (size_t i = 0; i < ARRAY_SIZE(entries); ++i)
	{
		const test_entry& e = entries[i];

		number a(e.lhs), b(e.rhs), c(e.result);
		
#define GEN_OP(op, chop)	case chop: \
							{ \
								BOOST_CHECK_EQUAL(a op b, c); \
								\
								number d = a; \
								d op##= b; \
								\
								BOOST_CHECK_EQUAL(d, c); \
								\
								if (a.template can_convert_to<boost::int64_t>()) \
								{ \
									BOOST_CHECK_EQUAL(a.template to_number<boost::int64_t>() op b, c); \
								} \
								\
								if (b.template can_convert_to<boost::int64_t>()) \
								{ \
									BOOST_CHECK_EQUAL(a op b.template to_number<boost::int64_t>(), c); \
								} \
							} break

#define GEN_SOP(op, chop)	case chop: \
							{ \
								if (b.template can_convert_to<boost::uint64_t>()) \
								{ \
									boost::uint64_t ub = b.template to_number<boost::uint64_t>(); \
									\
									BOOST_CHECK_EQUAL(a op ub, c); \
									\
									number d = a; \
									d op##= ub; \
									\
									BOOST_CHECK_EQUAL(d, c); \
								} \
								else BOOST_CHECK(false); \
							} break

		switch (e.op)
		{
		GEN_OP(+, '+');
		GEN_OP(-, '-');
		GEN_OP(*, '*');
		GEN_OP(/, '/');
		GEN_OP(%, '%');
		GEN_OP(&, '&');
		GEN_OP(|, '|');
		GEN_OP(^, '^');
		GEN_SOP(<<, '<');
		GEN_SOP(>>, '>');
		}

#undef GEN_SOP
#undef GEN_OP	
	}
}

int test_main(int argc, char* argv[])
{
#ifdef BOOST_BIGINT_HAS_GMP_SUPPORT
	test<boost::detail::bigint_gmp_implementation>();
#endif

	test<boost::detail::bigint_default_implementation<boost::detail::bigint_storage_vector, 8> >();
	test<boost::detail::bigint_default_implementation<boost::detail::bigint_storage_vector, 16> >();
	test<boost::detail::bigint_default_implementation<boost::detail::bigint_storage_vector, 32> >();

	test<boost::detail::bigint_default_implementation<boost::detail::bigint_storage_fixed<1024>::type, 8> >();
	test<boost::detail::bigint_default_implementation<boost::detail::bigint_storage_fixed<1024>::type, 16> >();
	test<boost::detail::bigint_default_implementation<boost::detail::bigint_storage_fixed<1024>::type, 32> >();

	return 0;
}
