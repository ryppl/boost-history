<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Tutorials</title>
<link rel="stylesheet" href="../boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.73.2">
<link rel="start" href="../index.html" title="Chapter 1. Boost.Intrusive">
<link rel="up" href="../index.html" title="Chapter 1. Boost.Intrusive">
<link rel="prev" href="introduction.html" title="Introduction">
<link rel="next" href="using.html" title="Using Boost.Persistent">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr>
<td valign="top"><img alt="Boost C++ Libraries" width="277" height="86" src="../../../../../boost.png"></td>
<td align="center"><a href="../../../../../index.html">Home</a></td>
<td align="center"><a href="../../../../../libs/libraries.htm">Libraries</a></td>
<td align="center"><a href="http://www.boost.org/users/people.html">People</a></td>
<td align="center"><a href="http://www.boost.org/users/faq.html">FAQ</a></td>
<td align="center"><a href="../../../../../more/index.htm">More</a></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="introduction.html"><img src="../../../../../doc/html/images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../../../../../doc/html/images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../../../../../doc/html/images/home.png" alt="Home"></a><a accesskey="n" href="using.html"><img src="../../../../../doc/html/images/next.png" alt="Next"></a>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="persistent.tutorials"></a><a class="link" href="tutorials.html" title="Tutorials"> Tutorials</a>
</h2></div></div></div>
<div class="toc"><dl>
<dt><span class="section"><a href="tutorials.html#persistent.tutorials.tutorial1"> Tutorial 1: Storing
      an object</a></span></dt>
<dt><span class="section"><a href="tutorials.html#persistent.tutorials.tutorial2"> Tutorial 2: Linked list</a></span></dt>
<dt><span class="section"><a href="tutorials.html#persistent.tutorials.tutorial3"> Tutorial 3: Persistent
      containers</a></span></dt>
<dt><span class="section"><a href="tutorials.html#persistent.tutorials.conctx"> Tutorial 4: Using Concurrent
      Transactions</a></span></dt>
</dl></div>
<p>
      It is recommended to read the <a class="link" href="introduction.html" title="Introduction">Introduction</a>
      first, especially the part about <a class="link" href="introduction.html#persistent.introduction.locators" title="Locators (vs. pointers)">locators</a>,
      as they are used throughout the tutorials.
    </p>
<div class="section" lang="en">
<div class="titlepage"><div><div><h3 class="title">
<a name="persistent.tutorials.tutorial1"></a><a class="link" href="tutorials.html#persistent.tutorials.tutorial1" title="Tutorial 1: Storing an object"> Tutorial 1: Storing
      an object</a>
</h3></div></div></div>
<div class="toc"><dl>
<dt><span class="section"><a href="tutorials.html#persistent.tutorials.tutorial1.type"> Defining a persistent
        class</a></span></dt>
<dt><span class="section"><a href="tutorials.html#persistent.tutorials.tutorial1.createdb"> Creating
        a database</a></span></dt>
<dt><span class="section"><a href="tutorials.html#persistent.tutorials.tutorial1.createobj"> Creating
        a persistent object</a></span></dt>
<dt><span class="section"><a href="tutorials.html#persistent.tutorials.tutorial1.pinning"> Object pinning</a></span></dt>
<dt><span class="section"><a href="tutorials.html#persistent.tutorials.tutorial1.modify"> Modifying an
        object</a></span></dt>
<dt><span class="section"><a href="tutorials.html#persistent.tutorials.tutorial1.read"> Reading an object</a></span></dt>
<dt><span class="section"><a href="tutorials.html#persistent.tutorials.tutorial1.delete"> Deleting an
        object</a></span></dt>
</dl></div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h4 class="title">
<a name="persistent.tutorials.tutorial1.type"></a><a class="link" href="tutorials.html#persistent.tutorials.tutorial1.type" title="Defining a persistent class"> Defining a persistent
        class</a>
</h4></div></div></div>
<p>
          A type that is to be used for a persistent object must by Serializable
          as defined by Boost.Serialization:
        </p>
<p>
          
</p>
<pre class="programlisting"><span class="keyword">struct</span> <span class="identifier">address</span><span class="special">{</span>
	<span class="identifier">string</span> <span class="identifier">name</span><span class="special">;</span>
	<span class="identifier">string</span> <span class="identifier">street</span><span class="special">;</span>
	<span class="keyword">int</span> <span class="identifier">number</span><span class="special">;</span>
	<span class="keyword">template</span><span class="special">&lt;</span><span class="keyword">class</span> <span class="identifier">Archive</span><span class="special">&gt;</span>
	<span class="keyword">void</span> <span class="identifier">serialize</span><span class="special">(</span><span class="identifier">Archive</span> <span class="special">&amp;</span><span class="identifier">ar</span><span class="special">,</span><span class="keyword">unsigned</span> <span class="keyword">int</span><span class="special">){</span>
		<span class="identifier">ar</span> <span class="special">&amp;</span> <span class="identifier">name</span> <span class="special">&amp;</span> <span class="identifier">street</span> <span class="special">&amp;</span> <span class="identifier">number</span><span class="special">;</span>
	<span class="special">}</span>
<span class="special">};</span>
</pre>
<p>
        </p>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h4 class="title">
<a name="persistent.tutorials.tutorial1.createdb"></a><a class="link" href="tutorials.html#persistent.tutorials.tutorial1.createdb" title="Creating a database"> Creating
        a database</a>
</h4></div></div></div>
<p>
          A default object database can be constructed most easily by using the
          <code class="computeroutput"><a class="link" href="../boost/persistent/object_database.html" title="Class object_database">object_database</a></code>
          class: 
</p>
<pre class="programlisting"><span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">persistent</span><span class="special">/</span><span class="identifier">object_database</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">persistent</span><span class="special">;</span>

<span class="keyword">int</span> <span class="identifier">main</span><span class="special">(){</span>
	<span class="identifier">object_database</span><span class="special">&lt;&gt;</span> <span class="identifier">db</span><span class="special">(</span><span class="string">"mydb"</span><span class="special">);</span>
<span class="special">}</span>
</pre>
<p>
        </p>
<p>
          <span class="emphasis"><em>mydb</em></span> represents the name of the database, that is,
          extended by various file extensions, used as a filename to store the database.
        </p>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h4 class="title">
<a name="persistent.tutorials.tutorial1.createobj"></a><a class="link" href="tutorials.html#persistent.tutorials.tutorial1.createobj" title="Creating a persistent object"> Creating
        a persistent object</a>
</h4></div></div></div>
<p>
          
</p>
<pre class="programlisting"><span class="identifier">transaction</span> <span class="identifier">tx</span><span class="special">;</span>
<span class="identifier">loc</span><span class="special">&lt;</span><span class="identifier">address</span><span class="special">&gt;</span> <span class="identifier">myaddress</span><span class="special">(</span><span class="keyword">new</span> <span class="identifier">address</span><span class="special">);</span>
<span class="identifier">tx</span><span class="special">.</span><span class="identifier">commit</span><span class="special">();</span>
</pre>
<p>
        </p>
<p>
          A <code class="computeroutput"><a class="link" href="../boost/persistent/basic_loc.html" title="Class template basic_loc">loc</a></code> is a locator
          that is equivalent to a C++ raw pointer: There is no ownership management,
          the object needs to be deleted manually when it is no longer used.
        </p>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h4 class="title">
<a name="persistent.tutorials.tutorial1.pinning"></a><a class="link" href="tutorials.html#persistent.tutorials.tutorial1.pinning" title="Object pinning"> Object pinning</a>
</h4></div></div></div>
<p>
          The object is stored by the code above, but once the application has shut
          down the <span class="emphasis"><em>loc</em></span> is lost and there is no way to retrieve
          the object (and since loc is a locator with no ownership management, there
          is a leak in the database file). <code class="computeroutput"><a class="link" href="../boost/persistent/basic_loc.html#id2654096-bb">loc&lt;T&gt;::pin</a></code>
          associates a persistent object with a type, so it can be retrieved from
          the database later without having a locator to it:
        </p>
<p>
          
</p>
<pre class="programlisting"><span class="identifier">loc</span><span class="special">&lt;</span><span class="identifier">address</span><span class="special">&gt;</span> <span class="identifier">myaddress</span><span class="special">=</span><span class="identifier">loc</span><span class="special">&lt;</span><span class="identifier">address</span><span class="special">&gt;::</span><span class="identifier">pinned</span><span class="special">();</span>
<span class="keyword">if</span><span class="special">(!</span><span class="identifier">myaddress</span><span class="special">){</span>
  <span class="identifier">transaction</span> <span class="identifier">tx</span><span class="special">;</span>
  <span class="identifier">myaddress</span><span class="special">.</span><span class="identifier">reset</span><span class="special">(</span><span class="keyword">new</span> <span class="identifier">address</span><span class="special">);</span>
  <span class="identifier">myaddress</span><span class="special">.</span><span class="identifier">pin</span><span class="special">();</span>
  <span class="identifier">tx</span><span class="special">.</span><span class="identifier">commit</span><span class="special">();</span>
<span class="special">}</span>
</pre>
<p>
        </p>
<p>
          This code snippet tries to retrieve a previously stored object. If there
          is none, it creates a new one and associates the object referened by <span class="emphasis"><em>myaddress</em></span>
          with its own type, <span class="emphasis"><em>address</em></span>.
        </p>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h4 class="title">
<a name="persistent.tutorials.tutorial1.modify"></a><a class="link" href="tutorials.html#persistent.tutorials.tutorial1.modify" title="Modifying an object"> Modifying an
        object</a>
</h4></div></div></div>
<p>
          A persistent object can be modified by dereferencing a locator inside a
          transaction scope:
        </p>
<p>
          
</p>
<pre class="programlisting"><span class="identifier">loc</span><span class="special">&lt;</span><span class="identifier">address</span><span class="special">&gt;</span> <span class="identifier">myaddress</span><span class="special">=...;</span>
<span class="identifier">transaction</span> <span class="identifier">tx</span><span class="special">;</span>
<span class="identifier">myaddress</span><span class="special">-&gt;</span><span class="identifier">name</span><span class="special">=</span><span class="string">"Mike"</span><span class="special">;</span>
<span class="identifier">tx</span><span class="special">.</span><span class="identifier">commit</span><span class="special">();</span>
</pre>
<p>
        </p>
<p>
          If anything inside the transaction scope throws an exception, transaction::commit()
          won't get called and the changes are undone.
        </p>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h4 class="title">
<a name="persistent.tutorials.tutorial1.read"></a><a class="link" href="tutorials.html#persistent.tutorials.tutorial1.read" title="Reading an object"> Reading an object</a>
</h4></div></div></div>
<p>
          Reading an object inside a transaction scope is equal to writing to it:
        </p>
<p>
          
</p>
<pre class="programlisting"><span class="identifier">transaction</span> <span class="identifier">tx</span><span class="special">;</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">myaddress</span><span class="special">-&gt;</span><span class="identifier">name</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
</pre>
<p>
        </p>
<p>
          Objects can be read outside of transaction scopes, but there are some exceptions.
          The following code works fine:
        </p>
<p>
          
</p>
<pre class="programlisting"><span class="identifier">loc</span><span class="special">&lt;</span><span class="identifier">address</span> <span class="keyword">const</span><span class="special">&gt;</span> <span class="identifier">myaddress</span><span class="special">=...;</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">myaddress</span><span class="special">-&gt;</span><span class="identifier">name</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
</pre>
<p>
        </p>
<p>
          Note that the locator references a const object. The following code however
          results in a <code class="computeroutput"><a class="link" href="../boost/persistent/no_active_transaction.html" title="Struct no_active_transaction">no_active_transaction</a></code>
          exception:
        </p>
<p>
          
</p>
<pre class="programlisting"><span class="identifier">loc</span><span class="special">&lt;</span><span class="identifier">address</span><span class="special">&gt;</span> <span class="identifier">myaddress</span><span class="special">=...;</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">myaddress</span><span class="special">-&gt;</span><span class="identifier">name</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span> <span class="comment">//throws
</span></pre>
<p>
        </p>
<p>
          The reason for that is that a non-const object is requested and persistent
          objects can not be modified outside of transaction scopes. To read an object
          from a non-const locator the locator can either be (implicitely) cast to
          a const locator, or <code class="computeroutput"><a class="link" href="../boost/persistent/basic_loc.html#id2653952-bb">loc::read()</a></code>
          can be used:
        </p>
<p>
          
</p>
<pre class="programlisting"><span class="identifier">loc</span><span class="special">&lt;</span><span class="identifier">address</span><span class="special">&gt;</span> <span class="identifier">myaddress</span><span class="special">=...;</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">myaddress</span><span class="special">.</span><span class="identifier">read</span><span class="special">()-&gt;</span><span class="identifier">name</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span> <span class="comment">//ok
</span></pre>
<p>
        </p>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h4 class="title">
<a name="persistent.tutorials.tutorial1.delete"></a><a class="link" href="tutorials.html#persistent.tutorials.tutorial1.delete" title="Deleting an object"> Deleting an
        object</a>
</h4></div></div></div>
<p>
          An object can be deleted by using <code class="computeroutput"><a class="link" href="../boost/persistent/basic_loc.html#id2654219-bb">remove()</a></code>.
          It is the equivalent of the C++ <span class="emphasis"><em>delete</em></span> keyword for
          persistent objects. Since the <span class="emphasis"><em>address</em></span> object that
          was created above is <span class="emphasis"><em>pinned</em></span>, it needs to be <span class="emphasis"><em>unpinned</em></span>
          before the object is removed:
        </p>
<p>
          
</p>
<pre class="programlisting"><span class="identifier">loc</span><span class="special">&lt;</span><span class="identifier">address</span><span class="special">&gt;</span> <span class="identifier">myaddress</span><span class="special">=...;</span>
<span class="identifier">myaddress</span><span class="special">.</span><span class="identifier">unpin</span><span class="special">();</span>
<span class="identifier">myaddress</span><span class="special">.</span><span class="identifier">remove</span><span class="special">();</span>
</pre>
<p>
        </p>
<p>
          Note that persistent objects managed by <code class="computeroutput"><a class="link" href="../boost/persistent/basic_scoped_loc.html" title="Class template basic_scoped_loc">scoped_locs</a></code>
          and <code class="computeroutput">shared_locs</code>
          are deleted automatically. These locators should be preferred except in
          controlled cases, like container classes, much like C++ raw pointers to
          heap-allocated objects can often be avoided.
        </p>
</div>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h3 class="title">
<a name="persistent.tutorials.tutorial2"></a><a class="link" href="tutorials.html#persistent.tutorials.tutorial2" title="Tutorial 2: Linked list"> Tutorial 2: Linked list</a>
</h3></div></div></div>
<div class="toc"><dl>
<dt><span class="section"><a href="tutorials.html#persistent.tutorials.tutorial2.intro"> Introduction</a></span></dt>
<dt><span class="section"><a href="tutorials.html#persistent.tutorials.tutorial2.add"> Inserting an object</a></span></dt>
<dt><span class="section"><a href="tutorials.html#persistent.tutorials.tutorial2.remove"> Removing an
        object</a></span></dt>
</dl></div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h4 class="title">
<a name="persistent.tutorials.tutorial2.intro"></a><a class="link" href="tutorials.html#persistent.tutorials.tutorial2.intro" title="Introduction"> Introduction</a>
</h4></div></div></div>
<p>
          Locators can not only be used at runtime to access persistent objects,
          but they can be stored as a part of a persistent object:
        </p>
<p>
          
</p>
<pre class="programlisting"><span class="keyword">struct</span> <span class="identifier">node</span><span class="special">{</span>
  <span class="keyword">explicit</span> <span class="identifier">node</span><span class="special">(</span><span class="keyword">int</span> <span class="identifier">v</span><span class="special">,</span><span class="identifier">shared_loc</span><span class="special">&lt;</span><span class="identifier">node</span><span class="special">&gt;</span> <span class="identifier">n</span><span class="special">)</span> <span class="special">:</span> <span class="identifier">value</span><span class="special">(</span><span class="identifier">v</span><span class="special">),</span><span class="identifier">next</span><span class="special">(</span><span class="identifier">n</span><span class="special">){}</span>
  <span class="keyword">int</span> <span class="identifier">value</span><span class="special">;</span>
  <span class="identifier">shared_loc</span><span class="special">&lt;</span><span class="identifier">node</span><span class="special">&gt;</span> <span class="identifier">next</span><span class="special">;</span>
  <span class="keyword">template</span><span class="special">&lt;</span><span class="keyword">class</span> <span class="identifier">Archive</span><span class="special">&gt;</span>
  <span class="keyword">void</span> <span class="identifier">serialize</span><span class="special">(</span><span class="identifier">Archive</span> <span class="special">&amp;</span><span class="identifier">ar</span><span class="special">,</span><span class="keyword">unsigned</span> <span class="keyword">int</span><span class="special">){</span>
    <span class="identifier">ar</span> <span class="special">&amp;</span> <span class="identifier">value</span> <span class="special">&amp;</span> <span class="identifier">next</span><span class="special">;</span>
  <span class="special">}</span>
<span class="special">};</span>
</pre>
<p>
        </p>
<p>
          Here, a <code class="computeroutput">shared_loc</code>
          is used to reference the next object in a singly linked list. There is
          no need to remove the objects manually from the database when they are
          no longer used by the list, because <span class="emphasis"><em>shared_loc</em></span> manages
          the lifetime of the referenced object.
        </p>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h4 class="title">
<a name="persistent.tutorials.tutorial2.add"></a><a class="link" href="tutorials.html#persistent.tutorials.tutorial2.add" title="Inserting an object"> Inserting an object</a>
</h4></div></div></div>
<p>
          
</p>
<pre class="programlisting"><span class="keyword">void</span> <span class="identifier">insert_after</span><span class="special">(</span><span class="identifier">shared_loc</span><span class="special">&lt;</span><span class="identifier">node</span><span class="special">&gt;</span> <span class="identifier">after</span><span class="special">,</span><span class="keyword">int</span> <span class="identifier">value</span><span class="special">)</span>
  <span class="identifier">transaction</span> <span class="identifier">tx</span><span class="special">;</span>
  <span class="identifier">node</span> <span class="special">*</span><span class="identifier">newnode</span><span class="special">=</span><span class="identifier">node</span><span class="special">(</span><span class="identifier">value</span><span class="special">,</span><span class="identifier">after</span><span class="special">-&gt;</span><span class="identifier">next</span><span class="special">);</span>
  <span class="identifier">after</span><span class="special">-&gt;</span><span class="identifier">next</span><span class="special">=</span><span class="identifier">shared_loc</span><span class="special">&lt;</span><span class="identifier">node</span><span class="special">&gt;(</span><span class="identifier">newnode</span><span class="special">);</span>
  <span class="identifier">tx</span><span class="special">.</span><span class="identifier">commit</span><span class="special">();</span>
<span class="special">}</span>
</pre>
<p>
        </p>
<p>
          An object is inserted after the passed node, with value <span class="emphasis"><em>value</em></span>.
        </p>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h4 class="title">
<a name="persistent.tutorials.tutorial2.remove"></a><a class="link" href="tutorials.html#persistent.tutorials.tutorial2.remove" title="Removing an object"> Removing an
        object</a>
</h4></div></div></div>
<p>
          
</p>
<pre class="programlisting"><span class="keyword">void</span> <span class="identifier">remove_after</span><span class="special">(</span><span class="identifier">shared_loc</span><span class="special">&lt;</span><span class="identifier">node</span><span class="special">&gt;</span> <span class="identifier">after</span><span class="special">){</span>
  <span class="identifier">transaction</span> <span class="identifier">tx</span><span class="special">;</span>
  <span class="identifier">after</span><span class="special">-&gt;</span><span class="identifier">next</span><span class="special">=</span><span class="identifier">after</span><span class="special">-&gt;</span><span class="identifier">next</span><span class="special">-&gt;</span><span class="identifier">next</span><span class="special">;</span>
  <span class="identifier">tx</span><span class="special">.</span><span class="identifier">commit</span><span class="special">();</span>
<span class="special">}</span>
</pre>
<p>
        </p>
<p>
          The object after <span class="emphasis"><em>after</em></span> is removed. It is no longer
          referenced from any shared_loc, so it is deleted from the database. In
          a similar way, all objects after a certain node can be deleted:
        </p>
<p>
          
</p>
<pre class="programlisting"><span class="keyword">void</span> <span class="identifier">remove_all_after</span><span class="special">(</span><span class="identifier">shared_loc</span><span class="special">&lt;</span><span class="identifier">node</span><span class="special">&gt;</span> <span class="identifier">after</span><span class="special">){</span>
  <span class="identifier">transaction</span> <span class="identifier">tx</span><span class="special">;</span>
  <span class="identifier">after</span><span class="special">-&gt;</span><span class="identifier">next</span><span class="special">.</span><span class="identifier">reset</span><span class="special">();</span>
  <span class="identifier">tx</span><span class="special">.</span><span class="identifier">commit</span><span class="special">();</span>
<span class="special">}</span>
</pre>
<p>
        </p>
<p>
          The thousands of objects that may have been in the linked list after <span class="emphasis"><em>after</em></span>
          are deleted from the database, since they are no longer reachable.
        </p>
</div>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h3 class="title">
<a name="persistent.tutorials.tutorial3"></a><a class="link" href="tutorials.html#persistent.tutorials.tutorial3" title="Tutorial 3: Persistent containers"> Tutorial 3: Persistent
      containers</a>
</h3></div></div></div>
<p>
        The tutorial above shows a manually managed singly linked list of persistent
        objects. In actual use cases however you would want to use a STL container
        to do the work for you.
      </p>
<p>
        Standard STL containers can be stored as part of persistent objects:
      </p>
<p>
        
</p>
<pre class="programlisting"><span class="keyword">struct</span> <span class="identifier">bank</span><span class="special">{</span>
  <span class="identifier">std</span><span class="special">::</span><span class="identifier">list</span><span class="special">&lt;</span><span class="identifier">shared_loc</span><span class="special">&lt;</span><span class="identifier">account</span><span class="special">&gt;</span> <span class="special">&gt;</span> <span class="identifier">accounts</span><span class="special">;</span>
  <span class="keyword">template</span><span class="special">&lt;</span><span class="keyword">class</span> <span class="identifier">Archive</span><span class="special">&gt;</span>
  <span class="keyword">void</span> <span class="identifier">serialize</span><span class="special">(</span><span class="identifier">Archive</span> <span class="special">&amp;</span><span class="identifier">ar</span><span class="special">,</span><span class="keyword">unsigned</span> <span class="keyword">int</span><span class="special">){</span>
    <span class="identifier">ar</span> <span class="special">&amp;</span> <span class="identifier">accounts</span><span class="special">;</span>
  <span class="special">}</span>
<span class="special">};</span>
</pre>
<p>
      </p>
<p>
        This is sufficient in many cases, however, the whole container is part of
        one persistent object. So if an <span class="emphasis"><em>account</em></span> is added to
        a <span class="emphasis"><em>bank</em></span> the whole list of accounts is loaded, modified
        and saved. To avoid that and store large containers, <a class="link" href="using.html#persistent.using.ccontainers" title="Concurrent Access Containers">Concurrent
        Access Containers</a> can be used:
      </p>
<p>
        
</p>
<pre class="programlisting"><span class="keyword">struct</span> <span class="identifier">bank</span><span class="special">{</span>
  <span class="identifier">persistent</span><span class="special">::</span><span class="identifier">clist</span><span class="special">&lt;</span><span class="identifier">shared_loc</span><span class="special">&lt;</span><span class="identifier">account</span><span class="special">&gt;</span> <span class="special">&gt;</span> <span class="identifier">accounts</span><span class="special">;</span>
  <span class="keyword">template</span><span class="special">&lt;</span><span class="keyword">class</span> <span class="identifier">Archive</span><span class="special">&gt;</span>
  <span class="keyword">void</span> <span class="identifier">serialize</span><span class="special">(</span><span class="identifier">Archive</span> <span class="special">&amp;</span><span class="identifier">ar</span><span class="special">,</span><span class="keyword">unsigned</span> <span class="keyword">int</span><span class="special">){</span>
    <span class="identifier">ar</span> <span class="special">&amp;</span> <span class="identifier">accounts</span><span class="special">;</span>
  <span class="special">}</span>
<span class="special">};</span>
</pre>
<p>
      </p>
<p>
        These are containers that implement each container node as a persistent object.
        So in this case:
      </p>
<p>
        
</p>
<pre class="programlisting"><span class="identifier">shared_loc</span><span class="special">&lt;</span><span class="identifier">bank</span><span class="special">&gt;</span> <span class="identifier">mybank</span><span class="special">=...;</span>
<span class="identifier">mybank</span><span class="special">-&gt;</span><span class="identifier">accounts</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">shared_loc</span><span class="special">&lt;</span><span class="identifier">account</span><span class="special">&gt;(</span><span class="keyword">new</span> <span class="identifier">account</span><span class="special">));</span>
</pre>
<p>
      </p>
<p>
        accesses 4 small objects, no matter how many accounts there are in the list:
        The <span class="emphasis"><em>bank</em></span>, the <span class="emphasis"><em>accounts</em></span> container,
        the last <span class="emphasis"><em>account</em></span> in the list, and the newly created
        <span class="emphasis"><em>account</em></span>.
      </p>
<p>
        Concurrent access containers have the same interface as the standard STL
        containers <span class="emphasis"><em>list</em></span>, <span class="emphasis"><em>set</em></span>, <span class="emphasis"><em>multiset</em></span>,
        <span class="emphasis"><em>map</em></span> and <span class="emphasis"><em>multimap</em></span>. There are also
        intrusive versions in namespace <span class="emphasis"><em>boost::persistent::intrusive</em></span>
        which are modelled after Boost.Intrusive containers.
      </p>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h3 class="title">
<a name="persistent.tutorials.conctx"></a><a class="link" href="tutorials.html#persistent.tutorials.conctx" title="Tutorial 4: Using Concurrent Transactions"> Tutorial 4: Using Concurrent
      Transactions</a>
</h3></div></div></div>
<p>
        If the same persistent object is changed by 2 transactions concurrently,
        a <code class="computeroutput"><a class="link" href="../boost/persistent/isolation_exception.html" title="Struct isolation_exception">isolation_exception</a></code>
        may be thrown:
      </p>
<p>
        
</p>
<pre class="programlisting"><span class="keyword">void</span> <span class="identifier">thread_start</span><span class="special">(){</span>
  <span class="identifier">loc</span><span class="special">&lt;</span><span class="identifier">account</span><span class="special">&gt;</span> <span class="identifier">myaccount</span><span class="special">=</span><span class="identifier">loc</span><span class="special">&lt;</span><span class="identifier">account</span><span class="special">&gt;::</span><span class="identifier">pinned</span><span class="special">();</span>
  <span class="keyword">while</span><span class="special">(</span><span class="keyword">true</span><span class="special">){</span>
    <span class="identifier">transaction</span> <span class="identifier">tx</span><span class="special">;</span>
    <span class="identifier">myaccount</span><span class="special">-&gt;</span><span class="identifier">balance</span><span class="special">+=</span><span class="identifier">rand</span><span class="special">();</span>
    <span class="identifier">tx</span><span class="special">.</span><span class="identifier">commit</span><span class="special">();</span> <span class="comment">//throws
</span>  <span class="special">}</span>
<span class="special">}</span>
</pre>
<p>
      </p>
<p>
        <code class="computeroutput"><a class="link" href="../boost/persistent/basic_transaction.html#id2655050-bb">transaction::commit()</a></code>
        throws in case another transaction has accessed the object in a way that
        would result in a different result as if all transaction are executed in
        sequence. To handle this, an <span class="emphasis"><em>atomic scope</em></span> can be used
        to create the transaction scope:
      </p>
<p>
        
</p>
<pre class="programlisting"><span class="preprocessor">#define</span> <span class="identifier">atomic</span> <span class="identifier">BOOST_PERSISTENT_ATOMIC</span>
<span class="preprocessor">#define</span> <span class="identifier">retry</span> <span class="identifier">BOOST_PERSISTENT_RETRY</span>

<span class="keyword">void</span> <span class="identifier">thread_start</span><span class="special">(){</span>
  <span class="identifier">loc</span><span class="special">&lt;</span><span class="identifier">account</span><span class="special">&gt;</span> <span class="identifier">myaccount</span><span class="special">=</span><span class="identifier">loc</span><span class="special">&lt;</span><span class="identifier">account</span><span class="special">&gt;::</span><span class="identifier">pinned</span><span class="special">();</span>
  <span class="keyword">while</span><span class="special">(</span><span class="keyword">true</span><span class="special">){</span>
    <span class="keyword">int</span> <span class="identifier">amount</span><span class="special">=</span><span class="identifier">rand</span><span class="special">();</span>
    <span class="identifier">atomic</span><span class="special">{</span>
      <span class="identifier">myaccount</span><span class="special">-&gt;</span><span class="identifier">balance</span><span class="special">+=</span><span class="identifier">amount</span><span class="special">;</span>
    <span class="special">}</span> <span class="identifier">retry</span><span class="special">;</span>
  <span class="special">}</span>
<span class="special">}</span>
</pre>
<p>
      </p>
<p>
        In the case there is an isolation conflict between 2 or more transactions,
        <span class="emphasis"><em>atomic {} retry</em></span> catches the <span class="emphasis"><em>isolation_exception</em></span>
        and repeats the transaction until it is successfully committed.
      </p>
</div>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright © 2009 Stefan Strasser<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="introduction.html"><img src="../../../../../doc/html/images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../../../../../doc/html/images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../../../../../doc/html/images/home.png" alt="Home"></a><a accesskey="n" href="using.html"><img src="../../../../../doc/html/images/next.png" alt="Next"></a>
</div>
</body>
</html>
