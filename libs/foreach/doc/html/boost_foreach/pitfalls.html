<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Pitfalls</title>
<link rel="stylesheet" href="../boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.66.1">
<link rel="start" href="../index.html" title="Chapter 1. BOOST_FOREACH 1.0">
<link rel="up" href="../index.html" title="Chapter 1. BOOST_FOREACH 1.0">
<link rel="prev" href="extending_boost_foreach.html" title="Extending BOOST_FOREACH">
<link rel="next" href="portability.html" title="Portability">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><td valign="top"><img alt="boost.png (6897 bytes)" width="277" height="86" src="../../../../../boost.png"></td></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="extending_boost_foreach.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="portability.html"><img src="../images/next.png" alt="Next"></a>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="boost_foreach.pitfalls"></a>Pitfalls</h2></div></div></div>
<p>
This section describes some common pitfalls with <tt class="computeroutput"><span class="identifier">BOOST_FOREACH</span></tt>.</p>
<a name="pitfalls.types_with_commas"></a><h2>
<a name="id444185"></a>Types With Commas</h2>
<p>
Since <tt class="computeroutput"><span class="identifier">BOOST_FOREACH</span></tt> is a macro, it must have exactly two arguments, with exactly one
comma separating them. That's not always convenient, especially when the type of the
loop variable is a template. Consider trying to iterate over a <tt class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">map</span></tt>:</p>
<pre class="programlisting"><tt class="literal"><span class="identifier">std</span><span class="special">::</span><span class="identifier">map</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">,</span><span class="keyword">int</span><span class="special">&gt;</span><span class="identifier"> m</span><span class="special">;</span><span class="comment">

// ERROR! Too many arguments to BOOST_FOREACH macro.
</span><span class="identifier">BOOST_FOREACH</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">,</span><span class="keyword">int</span><span class="special">&gt;</span><span class="identifier"> p</span><span class="special">,</span><span class="identifier"> m</span><span class="special">)</span><span class="comment"> // ...
</span></tt></pre>
<p>
One way to fix this is with a typedef.</p>
<pre class="programlisting"><tt class="literal"><span class="identifier">std</span><span class="special">::</span><span class="identifier">map</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">,</span><span class="keyword">int</span><span class="special">&gt;</span><span class="identifier"> m</span><span class="special">;</span><span class="keyword">
typedef</span><span class="identifier"> std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">,</span><span class="keyword">int</span><span class="special">&gt;</span><span class="identifier"> pair_t</span><span class="special">;</span><span class="identifier">

BOOST_FOREACH</span><span class="special">(</span><span class="identifier">pair_t</span><span class="identifier"> p</span><span class="special">,</span><span class="identifier"> m</span><span class="special">)</span><span class="comment"> // ...
</span></tt></pre>
<p>
Another way to fix it is to predeclare the loop variable:</p>
<pre class="programlisting"><tt class="literal"><span class="identifier">std</span><span class="special">::</span><span class="identifier">map</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">,</span><span class="keyword">int</span><span class="special">&gt;</span><span class="identifier"> m</span><span class="special">;</span><span class="identifier">
std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">,</span><span class="keyword">int</span><span class="special">&gt;</span><span class="identifier"> p</span><span class="special">;</span><span class="identifier">

BOOST_FOREACH</span><span class="special">(</span><span class="identifier">p</span><span class="special">,</span><span class="identifier"> m</span><span class="special">)</span><span class="comment"> // ...
</span></tt></pre>
<a name="pitfalls.hoisting_and_iterator_invalidation"></a><h2>
<a name="id444666"></a>Hoisting and Iterator Invalidation</h2>
<p>
Under the covers, <tt class="computeroutput"><span class="identifier">BOOST_FOREACH</span></tt> uses iterators to traverse the element
sequence. Before the loop is executed, the end iterator is cached
in a local variable. This is called <span class="emphasis"><em>hoisting</em></span>, and it is an
important optimization. It assumes, however, that the end iterator
of the sequence is stable. It usually is, but if you modify the
sequence by adding or removing elements while you are iterating
over it, you may end up hoisting yourself on your on petard.</p>
<p>
Consider the following code:</p>
<pre class="programlisting"><tt class="literal"><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">&gt;</span><span class="identifier"> vect</span><span class="special">(</span><span class="number">4</span><span class="special">,</span><span class="number"> 4</span><span class="special">);</span><span class="identifier">
BOOST_FOREACH</span><span class="special">(</span><span class="keyword">int</span><span class="identifier"> i</span><span class="special">,</span><span class="identifier"> vect</span><span class="special">)</span><span class="special">
{</span><span class="identifier">
    vect</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">i</span><span class="special"> +</span><span class="number"> 1</span><span class="special">);</span><span class="special">
}</span></tt></pre>
<p>
This code will compile, but it has undefined behavior. That is because
it is logically equivalent to the following:</p>
<pre class="programlisting"><tt class="literal"><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">&gt;</span><span class="identifier"> vect</span><span class="special">(</span><span class="number">4</span><span class="special">,</span><span class="number"> 4</span><span class="special">);</span><span class="keyword">
for</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">&gt;::</span><span class="identifier">iterator</span><span class="identifier"> i1</span><span class="special"> =</span><span class="identifier"> vect</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span><span class="identifier"> i2</span><span class="special"> =</span><span class="identifier"> vect</span><span class="special">.</span><span class="identifier">end</span><span class="special">();</span><span class="identifier">
    i1</span><span class="special"> !=</span><span class="identifier"> i2</span><span class="special">;</span><span class="special"> ++</span><span class="identifier">i1</span><span class="special">)</span><span class="special">
{</span><span class="keyword">
    int</span><span class="identifier"> i</span><span class="special"> =</span><span class="special"> *</span><span class="identifier">i1</span><span class="special">;</span><span class="identifier">
    vect</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">i</span><span class="special"> +</span><span class="number"> 1</span><span class="special">);</span><span class="special">
}</span></tt></pre>
<p>
The call to <tt class="computeroutput"><span class="identifier">vect</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">()</span></tt> will cause all iterators into <tt class="computeroutput"><span class="identifier">vect</span></tt> to
become invalid, including <tt class="computeroutput"><span class="identifier">i1</span></tt> and <tt class="computeroutput"><span class="identifier">i2</span></tt>. The next iteration through
the loop will cause the invalid iterators to be used -- Blam-o! Bad news.</p>
<p>
The moral of the story is to think twice before adding and removing
elements from the sequence over which you are iterating. If doing
so could cause iterators to become invalid, don't do it. Use a regular
<tt class="computeroutput"><span class="keyword">for</span></tt> loop instead.</p>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><small>Copyright © 2004 Eric Niebler</small></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="extending_boost_foreach.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="portability.html"><img src="../images/next.png" alt="Next"></a>
</div>
</body>
</html>
