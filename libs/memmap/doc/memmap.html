<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
	<head>
		<title>Boost Memory Mapped File</title>
	</head>
	<body bgcolor="white" text="black">
		<table border="1" bgcolor="teal" cellpadding="2">
			<tr>
				<td bgcolor="white">
					<a href="../../../index.htm"><img src="../../../c++boost.gif" alt="Home" width="277" height="86" border="0"></a></td>
				<td><a href="../../../index.htm"><font face="Arial" color="white"><big>Home</big></font></a></td>
				<td><a href="../../libraries.htm"><font face="Arial" color="white"><big>Libraries</big></font></a></td>
				<td><a href="../../../people/people.htm"><font face="Arial" color="white"><big>People</big></font></a></td>
				<td><a href="../../../more/faq.htm"><font face="Arial" color="white"><big>FAQ</big></font></a></td>
				<td><a href="../../../more/index.htm"><font face="Arial" color="white"><big>More</big></font></a></td>
			</tr>
		</table>
		<font face="Times" size="3">
			<h1>Boost Memory Mapped File</h1>
			<h2>Rationale</h2>
			<p>A memory mapped file associates the contents of a file with a block of virtual
			address space of a process. The Win32 platform and POSIX standard provide means
			of creating and managing memory mapped files, however, the methods for this is
			different between the two. The intention of the Boost Memory Mapped File is to
			bridge the compatibility gap here, so that users can write portable code that
			uses memory mapped files.</p>
			<h2>Synopsis</h2>
			<p>There are two classes and one helper function.
			The <code>file</code> helper class is used to open and manage the scope of a file.
			The <code>memory_mapped_file</code> class manages the memory mapping of a file.
			The helper function <code>get_file_size()</code> returns the size of the file in
			bytes. It is declared in the <code>boost</code> namespace rather than
			<code>boost::detail</code> as it is a generally helpful function for the user of
			the library to call.</p>
			<pre>
filesize_t <b>get_file_size</b>(file_handle_t handle);

template&lt;typename T=char&gt;
class <b>file</b> : noncopyable
{
    private:
    err_t                err_;
    file_handle_t        handle_;
    std::basic_string&lt;T&gt; filepath_;

    public:
    file();
    file(const std::basic_string&lt;T&gt; &filepath, file_access access);
    ~file();

    bool close(void);
    bool create(const std::basic_string&lt;T&gt; &filepath);

    err_t                error(void)    const;
    std::basic_string&lt;T&gt; filepath(void) const;
    file_handle_t        handle(void)   const;
    filesize_t           size(void)     const;
    bool                 is_open(void)  const;

    bool open_readonly(const std::basic_string&lt;T&gt; &filepath);
    bool open_readwrite(const std::basic_string&lt;T&gt; &filepath);
};


template &lt;typename T, typename F=file&lt;char&gt; &gt;
class <b>memory_mapped_file</b> : noncopyable
{
    private:
    T             *ptr_;
    err_t          err_;
    detail_struct  detail_;

    public:
    memory_mapped_file();
    memory_mapped_file(F &file, file_access access);
    memory_mapped_file(file_handle_t &handle, file_access access);
    ~memory_mapped_file();

    bool map_readonly(file_handle_t handle);
    bool map_readwrite(file_handle_t handle);

    // this is exposed publicly for completeness, but is
    // unlikely to be used by the library user
    bool map(file_handle_t       &handle,
             protection_t        &prot,
             flags_or_security_t &fos,
             length_t            &len,
             offset_t            &off);

    // release the mapping
    bool     release(void);

    // is the object mapped to a file?
    bool     is_mapped(void) const;
    err_t    error(void)     const;

    // data accessibility
    T       *get(void);
    const T *get(void)       const;
};
			</pre>
			<h2>Example</h2>
			<pre>
int main(int, char **)
{
    boost::file<char> file("myfile.dat", boost::readonly);
    if (file.is_open())
    {
        boost::memory_mapped_file<char> myfile(file, boost::readonly);
        if (myfile.is_mapped())
        {
            if (myfile.is_mapped())
            {
                char *p = myfile.get();
            }
        }
    }

    return 0;
}
			</pre>
			<h2>Test Program</h2>
			<p>The test program has been compiled and tested with 4 compilers with 5 STL 
				variants.</p>
			<table border="1" cellspacing="0" cellpadding="6" width="100%">
				<tr bgcolor="#cc9966">
					<td><b>&nbsp;Compiler</b></td>
					<td><b>&nbsp;STL version</b></td>
					<td><b>&nbsp;Command Line</b></td>
					<td><b>&nbsp;Success/Failure</b></td>
				</tr>
				<tr>
					<td bgcolor="#cc9966"><font color="#ffffff"><b>&nbsp;Microsoft Visual C++.Net (VC7)</b></font></td>
					<td bgcolor="#ffcc66">Dinkumware (with compiler)</td>
					<td bgcolor="#ffcc66">Using the project file <code>mapmem.vcproj</code></td>
					<td bgcolor="#ffcc66">Success.</td>
				</tr>
				<tr>
					<td bgcolor="#cc9966"><font color="#ffffff"><b>&nbsp;Microsoft Visual C++.Net (VC7)</b></font></td>
					<td bgcolor="#ffcc66">STLport-4.5.3</td>
					<td bgcolor="#ffcc66">Using the project file <code>mapmem.vcproj</code></td>
					<td bgcolor="#ffcc66">Success.</td>
				</tr>
				<tr>
					<td bgcolor="#cc9966"><font color="#ffffff"><b>&nbsp;Microsoft Visual C++ v6</b></font></td>
					<td bgcolor="#ffcc66">Dinkumware (with compiler)</td>
					<td bgcolor="#ffcc66"><code>cl mapmem.cpp -GX</code></td>
					<td bgcolor="#ffcc66">Success.</td>
				</tr>
				<tr>
					<td bgcolor="#cc9966"><font color="#ffffff"><b>&nbsp;g++ 3.1.1 20020718 (prerelease) 
								(Cygwin)</b></font></td>
					<td bgcolor="#ffcc66">Compiler</td>
					<td bgcolor="#ffcc66"><code>g++ mapmem.cpp</code></td>
					<td bgcolor="#ffcc66">Success.</td>
				</tr>
				<tr>
					<td bgcolor="#cc9966"><font color="#ffffff"><b>&nbsp;Borland Free C++ 5.5.1</b></font></td>
					<td bgcolor="#ffcc66">Compiler</td>
					<td bgcolor="#ffcc66"><code>bcc32 mapmem.cpp</code></td>
					<td bgcolor="#ffcc66">Success.</td>
				</tr>
				<tr>
					<td bgcolor="#cc9966"><font color="#ffffff"><b>&nbsp;Borland Free C++ 5.5.1</b></font></td>
					<td bgcolor="#ffcc66">STLport-4.5.3</td>
					<td bgcolor="#ffcc66"><code>bcc32 mapmem.cpp</code></td>
					<td bgcolor="#ffcc66">Success.</td>
				</tr>
			</table>
			<h2>Disclaimer</h2>
			<p>&copy; Copyright 2002, <a href="mailto:cdm.henderson@virgin.net">Craig Henderson</a></p>
			<p><i>Permission to use, copy, modify, distribute and sell this software and its 
					documentation for any purpose is hereby granted without fee, provided that the 
					above copyright notice appears in all copies and that both that copyright 
					notice and this permission notice appear in supporting documentation. The 
					author makes no representations about the suitability of this software for any 
					purpose. It is provided "as is" without express or implied warranty.</i></p>
			<p><i>Thanks to Malte Starostik suggesting the <code>file</code> helper class and 64-bit
					POSIX support.</i></p>
			<hr>
			<i>Last Revised: 13th October, 2002</i> </font>
	</body>
</html>
