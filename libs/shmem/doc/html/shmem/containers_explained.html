<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title> Shmem and containers in shared memory</title>
<link rel="stylesheet" href="../boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.67.0">
<link rel="start" href="../index.html" title="Chapter 1. Shmem 2006-01-12">
<link rel="up" href="../index.html" title="Chapter 1. Shmem 2006-01-12">
<link rel="prev" href="stl_allocators.html" title=" Shmem STL compatible allocators">
<link rel="next" href="customizing_boost_shmem.html" title=" Customizing Shmem">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%">
<td valign="top"><img alt="boost.png (6897 bytes)" width="277" height="86" src="../../../../../boost.png"></td>
<td align="center"><a href="../../../../../index.htm">Home</a></td>
<td align="center"><a href="../libraries.html">Libraries</a></td>
<td align="center"><a href="../../../../../people/people.htm">People</a></td>
<td align="center"><a href="../../../../../more/faq.htm">FAQ</a></td>
<td align="center"><a href="../../../../../more/index.htm">More</a></td>
</table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="stl_allocators.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="customizing_boost_shmem.html"><img src="../images/next.png" alt="Next"></a>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="shmem.containers_explained"></a> Shmem and containers in shared memory</h2></div></div></div>
<div class="toc"><dl>
<dt><span class="section"><a href="containers_explained.html#shmem.stl_container_requirements"> Container requirements for Shmem allocators</a></span></dt>
<dt><span class="section"><a href="containers_explained.html#shmem.containers"> STL containers in shared memory</a></span></dt>
<dt><span class="section"><a href="containers_explained.html#shmem.where_allocate"> Where is this being allocated?</a></span></dt>
</dl></div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h3 class="title">
<a name="shmem.stl_container_requirements"></a> Container requirements for Shmem allocators</h3></div></div></div>
<p>
Shmem STL compatible allocators offer a STL compatible allocator interface and 
if they define their internal <span class="bold"><strong>pointer</strong></span> typedef as offset_ptr&lt;T&gt;, they can 
be used to place STL containers in shared memory.</p>
<p>
However, as Scott Meyers mentions in his Effective STL 
book, Item 10, <span class="emphasis"><em>"Be aware of allocator conventions and 
restrictions"</em></span>:</p>
<div class="itemizedlist"><ul type="disc">
<li><span class="emphasis"><em>"the Standard explicitly allows library implementers 
to assume that every allocator's pointer typedef is 
a synonym for T*"</em></span></li>
<li><span class="emphasis"><em>"the Standard says that an implementation of the STL is 
permitted to assume that all allocator objects of the 
same type are equivalent and always compare equal"</em></span></li>
</ul></div>
<p>
Obviously, if any STL implementation ignores pointer typedefs, 
no smart pointer can be used as allocator::pointer. If STL 
implementations assume all allocator objects of the same 
type compare equal, it will assume that two allocators, 
each one allocating from a different shared memory segment 
are equal, which is a complete disaster.</p>
<p>
STL container implementations that we want to place in shared 
memory with Shmem can't make any of these assumptions, so:</p>
<div class="itemizedlist"><ul type="disc">
<li>
STL containers may not assume that memory allocated with 
  an allocator can be deallocated with other allocators of 
  the same type. All allocators objects must compare equal 
  only if memory allocated with one object can be deallocated 
  with the other one, and this can only tested with 
  operator==() at run-time.
</li>
<li>
Containers' internal pointers should be of the type allocator::pointer 
  and containers may not assume allocator::pointer is a raw pointer.
</li>
<li>
All objects must be constructed-destroyed via 
  allocator::construct and allocator::destroy functions.
</li>
</ul></div>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h3 class="title">
<a name="shmem.containers"></a> STL containers in shared memory</h3></div></div></div>
<p>
Unfortunately, some STL implementations use raw pointers
for internal data and ignore allocator pointer typedefs 
and others suppose at some point that the allocator::typedef 
is T*. This is because in practice,
there wasn't need of allocators with a pointer typedef 
different from T* for pooled/node memory
allocators.</p>
<p>
Until STL implementations handle allocator::pointer typedefs
in a generic way, Shmem offers the following classes:</p>
<div class="itemizedlist"><ul type="disc">
<li>
<span class="bold"><strong>boost:shmem::vector</strong></span> is the implementation of std::vector ready for the shared memory.
</li>
<li>
<span class="bold"><strong>boost:shmem::deque</strong></span> is the implementation of std::deque ready for the shared memory.
</li>
<li>
<span class="bold"><strong>boost:shmem::list</strong></span> is the implementation of std::list ready for the shared memory.
</li>
<li>
<span class="bold"><strong>boost:shmem::slist</strong></span> is the implementation of SGI's slist container (singly linked list) ready for the shared memory.
</li>
<li>
<span class="bold"><strong>boost:shmem::set/multiset/map/multimap</strong></span> family is the implementation of 
   std::set/multiset/map/multimap family ready for the shared memory.
</li>
<li>
<span class="bold"><strong>boost:shmem::flat_set/flat_multiset/flat_map/flat_multimap</strong></span> classes are the 
   adaptation and extension of Andrei Alexandrescu's famous AssocVector class 
   from Loki library, ready for the shared memory. These classes offer the same 
   functionality as std::set/multiset/map/multimap implemented with an ordered vector, 
   which has faster lookups than the standard ordered associative containers 
   based on red-black trees, but slower insertions.
</li>
<li>
<span class="bold"><strong>boost:shmem::basic_string</strong></span> is the implementation of std::basic_string ready for 
   the shared memory. It's implemented using a vector-like contiguous storage, so
   it has fast c_string conversion and can be used with the 
   <a href="streams.html#shmem.vectorstream" title=" Formatting directly in your character vector: vectorstream">vectorstream</a> iostream formatting classes.
</li>
</ul></div>
<p>
All these containers have the same default arguments as standard 
containers and they can be used with other, non-shared memory 
allocators (std::allocator, or boost::pool_allocator, for example).</p>
<p>
To place any of these containers in shared memory, we must define
the allocator template parameter with a shared memory allocator
so that the container allocates the values in the shared memory.
To place the container itself in shared memory, we construct it
in shared memory just like any other object with Shmem:</p>
<p></p>
<pre class="programlisting"><code class="literal"><span class="preprocessor">#include</span><span class="special"> &lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">shmem</span><span class="special">/</span><span class="identifier">containers</span><span class="special">/</span><span class="identifier">vector</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span><span class="preprocessor">
#include</span><span class="special"> &lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">shmem</span><span class="special">/</span><span class="identifier">named_shared_object</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span><span class="keyword">

int</span><span class="identifier"> main</span><span class="special"> ()</span><span class="special">
{</span><span class="keyword">
   using</span><span class="keyword"> namespace</span><span class="identifier"> boost</span><span class="special">::</span><span class="identifier">shmem</span><span class="special">;</span><span class="comment">

   //Shared memory front-end that is able to construct objects
   //associated with a c-string
</span><span class="identifier">   named_shared_object</span><span class="identifier"> segment</span><span class="special">;</span><span class="comment">

   //Create the memory segment and initialize resources
</span><span class="keyword">   if</span><span class="special">(!</span><span class="identifier">segment</span><span class="special">.</span><span class="identifier">create</span><span class="special">(</span><span class="string">"/MySharedMemory"</span><span class="special">,</span><span class="comment">  //segment name
</span><span class="number">                      65536</span><span class="special">)){</span><span class="comment">            //segment size in bytes
</span><span class="keyword">      return</span><span class="special"> -</span><span class="number">1</span><span class="special">;</span><span class="special">
   }</span><span class="comment">

   //Alias an STL-like allocator of ints that allocates ints from the segment
</span><span class="keyword">   typedef</span><span class="identifier"> allocator</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">,</span><span class="identifier"> named_shared_object</span><span class="special">::</span><span class="identifier">segment_manager</span><span class="special">&gt;</span><span class="identifier"> 
      ShmemAllocator</span><span class="special">;</span><span class="comment">

   //Alias a vector that uses the previous STL-like allocator
</span><span class="keyword">   typedef</span><span class="identifier"> vector</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">,</span><span class="identifier"> ShmemAllocator</span><span class="special">&gt;</span><span class="identifier"> MyVector</span><span class="special">;</span><span class="keyword">

   int</span><span class="identifier"> initVal</span><span class="special">[]</span><span class="special">        =</span><span class="special"> {</span><span class="number">0</span><span class="special">,</span><span class="number"> 1</span><span class="special">,</span><span class="number"> 2</span><span class="special">,</span><span class="number"> 3</span><span class="special">,</span><span class="number"> 4</span><span class="special">,</span><span class="number"> 5</span><span class="special">,</span><span class="number"> 6</span><span class="special"> };</span><span class="keyword">
   const</span><span class="keyword"> int</span><span class="special"> *</span><span class="identifier">begVal</span><span class="special">    =</span><span class="identifier"> initVal</span><span class="special">;</span><span class="keyword">
   const</span><span class="keyword"> int</span><span class="special"> *</span><span class="identifier">endVal</span><span class="special">    =</span><span class="identifier"> initVal</span><span class="special"> +</span><span class="keyword"> sizeof</span><span class="special">(</span><span class="identifier">initVal</span><span class="special">)/</span><span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">initVal</span><span class="special">[</span><span class="number">0</span><span class="special">]);</span><span class="comment">

   //Initialize the STL-like allocator
</span><span class="keyword">   const</span><span class="identifier"> ShmemAllocator</span><span class="identifier"> alloc_inst</span><span class="special"> (</span><span class="identifier">segment</span><span class="special">.</span><span class="identifier">get_segment_manager</span><span class="special">());</span><span class="comment">

   //Construct the vector in the shared memory segment with the STL-like allocator 
   //from a range of iterators
</span><span class="identifier">   MyVector</span><span class="special"> *</span><span class="identifier">myvector</span><span class="special"> =</span><span class="identifier"> 
      segment</span><span class="special">.</span><span class="identifier">construct</span><span class="special">&lt;</span><span class="identifier">MyVector</span><span class="special">&gt;</span><span class="special">
        (</span><span class="string">"MyVector"</span><span class="special">)/*</span><span class="identifier">object</span><span class="identifier"> name</span><span class="special">*/</span><span class="special">
        (</span><span class="identifier">begVal</span><span class="comment">     /*first ctor parameter*/</span><span class="special">,</span><span class="identifier">
         endVal</span><span class="comment">     /*second ctor parameter*/</span><span class="special">,</span><span class="identifier"> 
         alloc_inst</span><span class="comment"> /*third ctor parameter*/</span><span class="special">);</span><span class="comment"> 

   //Use vector as your want
</span><span class="identifier">   std</span><span class="special">::</span><span class="identifier">sort</span><span class="special">(</span><span class="identifier">myvector</span><span class="special">-&gt;</span><span class="identifier">rbegin</span><span class="special">(),</span><span class="identifier"> myvector</span><span class="special">-&gt;</span><span class="identifier">rend</span><span class="special">());</span><span class="comment">
   // . . .
   //When done, destroy and delete vector from the segment
</span><span class="identifier">   segment</span><span class="special">.</span><span class="identifier">destroy</span><span class="special">&lt;</span><span class="identifier">MyVector</span><span class="special">&gt;(</span><span class="string">"MyVector"</span><span class="special">);</span><span class="keyword">
   return</span><span class="number"> 0</span><span class="special">;</span><span class="special">
}</span></code></pre>
<p>
These containers also show how easy is to create/modify 
an existing container making possible to place it in shared memory.</p>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h3 class="title">
<a name="shmem.where_allocate"></a> Where is this being allocated?</h3></div></div></div>
<p>
Shmem containers are placed in shared memory/memory mapped files, etc... using two 
mechanisms <span class="bold"><strong>at the same time</strong></span>:</p>
<div class="itemizedlist"><ul type="disc">
<li>
Shmem construct&lt;&gt;, find_or_construct&lt;&gt;... functions. These functions place a c++
  object in the shared memory/memory mapped file. But this places only the object,
  but <span class="bold"><strong>not</strong></span> the memory that this object may allocate dynamically.
</li>
<li>
Shared memory allocators. These allow allocating shared memory/memory mapped file
  portions so that containers can allocate dynamically fragments of memory to store
  new inserted elements.
</li>
</ul></div>
<p>
This means that to place <span class="bold"><strong>any</strong></span> Shmem container (including Shmem strings) in 
shared memory/memory mapped file all containers <span class="bold"><strong>must</strong></span>:</p>
<div class="itemizedlist"><ul type="disc">
<li>
Define their template allocator parameter to a shared memory one.
</li>
<li>
Every container constructor must take a shared memory allocator as parameter.
</li>
<li>
You must use construct&lt;&gt;/find_or_construct&lt;&gt;... functions to place the container
  in shared memory.
</li>
</ul></div>
<p>
If you do the first two points but you don't use construct&lt;&gt;/find_or_construct&lt;&gt; 
you are creating a container placed <span class="bold"><strong>only</strong></span> in your process but that allocates memory 
for contained types from shared memory/memory mapped file.</p>
<p>
Let's see an example:</p>
<p></p>
<pre class="programlisting"><code class="literal"><span class="preprocessor">#include</span><span class="special"> &lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">shmem</span><span class="special">/</span><span class="identifier">named_shared_object</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span><span class="preprocessor">
#include</span><span class="special"> &lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">shmem</span><span class="special">/</span><span class="identifier">containers</span><span class="special">/</span><span class="identifier">vector</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span><span class="preprocessor">
#include</span><span class="special"> &lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">shmem</span><span class="special">/</span><span class="identifier">containers</span><span class="special">/</span><span class="identifier">string</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span><span class="preprocessor">
#include</span><span class="special"> &lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">shmem</span><span class="special">/</span><span class="identifier">allocators</span><span class="special">/</span><span class="identifier">allocator</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span><span class="keyword">

int</span><span class="identifier"> main</span><span class="special"> ()</span><span class="special">
{</span><span class="keyword">
   using</span><span class="keyword"> namespace</span><span class="identifier"> boost</span><span class="special">::</span><span class="identifier">shmem</span><span class="special">;</span><span class="comment">
   //Typedefs
</span><span class="keyword">   typedef</span><span class="identifier"> allocator</span><span class="special">&lt;</span><span class="keyword">char</span><span class="special">,</span><span class="identifier"> named_shared_object</span><span class="special">::</span><span class="identifier">segment_manager</span><span class="special">&gt;</span><span class="identifier"> 
      CharAllocator</span><span class="special">;</span><span class="keyword">
   typedef</span><span class="identifier"> basic_string</span><span class="special">&lt;</span><span class="keyword">char</span><span class="special">,</span><span class="identifier"> std</span><span class="special">::</span><span class="identifier">char_traits</span><span class="special">&lt;</span><span class="keyword">char</span><span class="special">&gt;,</span><span class="identifier"> CharAllocator</span><span class="special">&gt;</span><span class="identifier">
      MyShmString</span><span class="special">;</span><span class="keyword">
   typedef</span><span class="identifier"> allocator</span><span class="special">&lt;</span><span class="identifier">MyShmString</span><span class="special">,</span><span class="identifier"> named_shared_object</span><span class="special">::</span><span class="identifier">segment_manager</span><span class="special">&gt;</span><span class="identifier">
      StringAllocator</span><span class="special">;</span><span class="keyword">      
   typedef</span><span class="identifier"> vector</span><span class="special">&lt;</span><span class="identifier">MyShmString</span><span class="special">,</span><span class="identifier"> StringAllocator</span><span class="special">&gt;</span><span class="identifier">
      MyShmStringVector</span><span class="special">;</span><span class="comment">

   //Open shared memory
</span><span class="identifier">   named_shared_object</span><span class="identifier"> shm</span><span class="special">;</span><span class="identifier">
   shm</span><span class="special">.</span><span class="identifier">create</span><span class="special">(</span><span class="string">"myshm"</span><span class="special">,</span><span class="number"> 10000</span><span class="special">);</span><span class="comment">

   //Create allocators
</span><span class="identifier">   CharAllocator</span><span class="identifier">     charallocator</span><span class="special">  (</span><span class="identifier">shm</span><span class="special">.</span><span class="identifier">get_segment_manager</span><span class="special">());</span><span class="identifier">
   StringAllocator</span><span class="identifier">   stringallocator</span><span class="special">(</span><span class="identifier">shm</span><span class="special">.</span><span class="identifier">get_segment_manager</span><span class="special">());</span><span class="comment">

   //This string is in only in this process (the pointer pointing to the
   //buffer that will hold the text is not in shared memory). 
   //But the buffer that will hold "this is my text" is allocated from 
   //shared memory
</span><span class="identifier">   MyShmString</span><span class="identifier"> mystring</span><span class="special">(</span><span class="identifier">charallocator</span><span class="special">);</span><span class="identifier">
   mystring</span><span class="special"> =</span><span class="string"> "this is my text"</span><span class="special">;</span><span class="comment">

   //This vector is in only in this process (the pointer pointing to the
   //buffer that will hold the MyShmString-s is not in shared memory). 
   //But the buffer that will hold 10 MyShmString-s is allocated from 
   //shared memory using StringAllocator. Since strings use a shared 
   //memory allocator (CharAllocator) the 10 buffers that hold 
   //"this is my text" text are also in shared memory.
</span><span class="identifier">   MyShmStringVector</span><span class="identifier"> myvector</span><span class="special">(</span><span class="identifier">stringallocator</span><span class="special">);</span><span class="identifier">
   myvector</span><span class="special">.</span><span class="identifier">insert</span><span class="special">(</span><span class="identifier">myvector</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span><span class="number"> 10</span><span class="special">,</span><span class="identifier"> mystring</span><span class="special">);</span><span class="comment">

   //This vector is fully constructed in shared memory. All pointers
   //and buffers are constructed in the same shared memory segment
   //This vector can be safely accessed from other processes.
</span><span class="identifier">   MyShmStringVector</span><span class="special"> *</span><span class="identifier">myshmvector</span><span class="special"> =</span><span class="identifier"> 
      shm</span><span class="special">.</span><span class="identifier">construct</span><span class="special">&lt;</span><span class="identifier">MyShmStringVector</span><span class="special">&gt;(</span><span class="string">"myshmvector"</span><span class="special">)(</span><span class="identifier">stringallocator</span><span class="special">);</span><span class="identifier">
   myshmvector</span><span class="special">-&gt;</span><span class="identifier">insert</span><span class="special">(</span><span class="identifier">myshmvector</span><span class="special">-&gt;</span><span class="identifier">begin</span><span class="special">(),</span><span class="number"> 10</span><span class="special">,</span><span class="identifier"> mystring</span><span class="special">);</span><span class="comment">

   //Destroy vector. This will free all strings that the vector contains
</span><span class="identifier">   shm</span><span class="special">.</span><span class="identifier">destroy_ptr</span><span class="special">(</span><span class="identifier">myshmvector</span><span class="special">);</span><span class="keyword">
   return</span><span class="number"> 0</span><span class="special">;</span><span class="special">
}</span></code></pre>
</div>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><small>Copyright © 2005 - 2006 Ion Gaztañaga</small></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="stl_allocators.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="customizing_boost_shmem.html"><img src="../images/next.png" alt="Next"></a>
</div>
</body>
</html>
